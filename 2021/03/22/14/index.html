<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zpano.cn","root":"/","images":"/images","scheme":"Pisces","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="读《以太坊技术详解与实战》笔记（下）">
<meta property="og:type" content="article">
<meta property="og:title" content="读《以太坊技术详解与实战》笔记（下）">
<meta property="og:url" content="https://zpano.cn/2021/03/22/14/index.html">
<meta property="og:site_name" content="Zpano&#39;s Blog">
<meta property="og:description" content="读《以太坊技术详解与实战》笔记（下）">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zpano.cn/2021/03/22/14/image-20210320220120589.png">
<meta property="og:image" content="https://zpano.cn/2021/03/22/14/image-20210321220444930.png">
<meta property="og:image" content="https://zpano.cn/2021/03/22/14/image-20210321220545250.png">
<meta property="og:image" content="https://zpano.cn/2021/03/22/14/image-20210321220715904.png">
<meta property="og:image" content="https://zpano.cn/2021/03/22/14/image-20210321220931862.png">
<meta property="og:image" content="https://zpano.cn/2021/03/22/14/image-20210321221038692.png">
<meta property="og:image" content="https://zpano.cn/2021/03/22/14/image-20210321221346793-1616336155318.png">
<meta property="og:image" content="https://zpano.cn/2021/03/22/14/image-20210322185706847.png">
<meta property="article:published_time" content="2021-03-22T14:27:33.000Z">
<meta property="article:modified_time" content="2021-09-08T08:45:39.000Z">
<meta property="article:author" content="Zpano">
<meta property="article:tag" content="区块链安全">
<meta property="article:tag" content="读书笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zpano.cn/2021/03/22/14/image-20210320220120589.png">


<link rel="canonical" href="https://zpano.cn/2021/03/22/14/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>读《以太坊技术详解与实战》笔记（下） | Zpano's Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zpano's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">不负韶华，不负野心</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%BB%E3%80%8A%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E6%88%98%E3%80%8B%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%8B%EF%BC%89"><span class="nav-number">1.</span> <span class="nav-text">读《以太坊技术详解与实战》笔记（下）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0"><span class="nav-number">1.1.</span> <span class="nav-text">第六章</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%95%E7%A5%A8-%E4%BB%A3%E7%A0%81%E4%B8%8E%E5%8E%9F%E7%89%88%E6%9C%89%E6%89%80%E5%B7%AE%E5%BC%82"><span class="nav-number">1.1.1.</span> <span class="nav-text">投票(代码与原版有所差异)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-revert-%E3%80%81assert-%E3%80%81require-%E4%B8%89%E8%80%85%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">1.revert()、assert()、require()三者的区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-memory%E4%B8%8Estorage%E5%8C%BA%E5%88%AB"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">2.memory与storage区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%87%BD%E6%95%B0%E6%9D%83%E9%99%90%E5%85%B3%E9%94%AE%E5%AD%97%E4%B8%8E%E4%BF%AE%E9%A5%B0%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">3.函数权限关键字与修饰关键字</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%8F%98%E9%95%BF%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84"><span class="nav-number">1.1.1.4.</span> <span class="nav-text">4.变长字节数组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E6%98%A0%E5%B0%84%E9%94%AE%E5%80%BC%E5%AF%B9"><span class="nav-number">1.1.1.5.</span> <span class="nav-text">5.映射键值对</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-tips"><span class="nav-number">1.1.1.6.</span> <span class="nav-text">6.tips</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8B%8D%E5%8D%96"><span class="nav-number">1.1.2.</span> <span class="nav-text">拍卖</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%BA%8B%E4%BB%B6"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">1.事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">2.函数返回值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-payable"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">3.payable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB-Re-Entrancy"><span class="nav-number">1.1.2.4.</span> <span class="nav-text">4.重入攻击-Re-Entrancy</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.1.2.4.1.</span> <span class="nav-text">修复建议</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%BD%AC%E8%B4%A6%E5%87%BD%E6%95%B0"><span class="nav-number">1.1.2.5.</span> <span class="nav-text">1.转账函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#transfer"><span class="nav-number">1.1.2.5.1.</span> <span class="nav-text">\.transfer()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#send"><span class="nav-number">1.1.2.5.2.</span> <span class="nav-text">\.send()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#call-value"><span class="nav-number">1.1.2.5.3.</span> <span class="nav-text">\.call.value()</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="nav-number">1.1.2.6.</span> <span class="nav-text">2.构造函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-constructor"><span class="nav-number">1.1.2.7.</span> <span class="nav-text">3. constructor</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="nav-number">1.1.3.</span> <span class="nav-text">状态机</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#debug%E8%B0%83%E8%AF%95"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">debug调试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">权限控制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0"><span class="nav-number">1.2.</span> <span class="nav-text">第七章</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ERC20"><span class="nav-number">1.2.1.</span> <span class="nav-text">ERC20</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">接口定义</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ERC721"><span class="nav-number">1.2.2.</span> <span class="nav-text">ERC721</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0"><span class="nav-number">1.3.</span> <span class="nav-text">第八章</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0"><span class="nav-number">1.4.</span> <span class="nav-text">第九章</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%8D%81%E7%AB%A0"><span class="nav-number">1.5.</span> <span class="nav-text">第十章</span></a></li></ol></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zpano"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Zpano</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zpano.cn/2021/03/22/14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Zpano">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zpano's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          读《以太坊技术详解与实战》笔记（下）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-22 22:27:33" itemprop="dateCreated datePublished" datetime="2021-03-22T22:27:33+08:00">2021-03-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-08 16:45:39" itemprop="dateModified" datetime="2021-09-08T16:45:39+08:00">2021-09-08</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">区块链安全</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>18k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>16 分钟</span>
    </span>
</div>

            <div class="post-description">读《以太坊技术详解与实战》笔记（下）</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="读《以太坊技术详解与实战》笔记（下）"><a href="#读《以太坊技术详解与实战》笔记（下）" class="headerlink" title="读《以太坊技术详解与实战》笔记（下）"></a>读《以太坊技术详解与实战》笔记（下）</h1><h2 id="第六章"><a href="#第六章" class="headerlink" title="第六章"></a>第六章</h2><h3 id="投票-代码与原版有所差异"><a href="#投票-代码与原版有所差异" class="headerlink" title="投票(代码与原版有所差异)"></a>投票(代码与原版有所差异)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Ballot &#123;</span><br><span class="line">    <span class="comment">//投票者Voter的数据结构</span></span><br><span class="line">    struct Voter &#123;</span><br><span class="line">        uint weight; <span class="comment">//该投票者的投票所占权重</span></span><br><span class="line">        bool voted;  <span class="comment">//是否投过票   </span></span><br><span class="line">        address delegate; <span class="comment">//投票对应的提案编号</span></span><br><span class="line">        uint vote;   <span class="comment">//该投票者投票权的委托对象</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    struct Proposal &#123;</span><br><span class="line">        bytes32 name;  <span class="comment">//提案名称   </span></span><br><span class="line">        uint voteCount; <span class="comment">//提案目前票数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    address <span class="keyword">public</span> chairperson;<span class="comment">//投票主持人</span></span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; Voter) <span class="keyword">public</span> voters;<span class="comment">//投票者地址与状态对应关系</span></span><br><span class="line"></span><br><span class="line">    Proposal[] <span class="keyword">public</span> proposals;<span class="comment">//提案的列表</span></span><br><span class="line">    <span class="comment">//初始化合约时，给定一个提案的列表</span></span><br><span class="line">    constructor(bytes32[] memory proposalNames) &#123;<span class="comment">//构造函数</span></span><br><span class="line">        chairperson = msg.sender;</span><br><span class="line">        voters[chairperson].weight = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; proposalNames.length; i++) &#123;</span><br><span class="line">            proposals.push(Proposal(&#123;</span><br><span class="line">                name: proposalNames[i],</span><br><span class="line">                voteCount: <span class="number">0</span></span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//只有投票主持者有给予Voter地址投票的权力</span></span><br><span class="line">    <span class="function">function <span class="title">giveRightToVote</span><span class="params">(address voter)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        require(</span><br><span class="line">            msg.sender == chairperson,</span><br><span class="line">            <span class="string">&quot;Only chairperson can give right to vote.&quot;</span></span><br><span class="line">        );<span class="comment">//是否为主持人</span></span><br><span class="line">        require(</span><br><span class="line">            !voters[voter].voted,</span><br><span class="line">            <span class="string">&quot;The voter already voted.&quot;</span></span><br><span class="line">        );<span class="comment">//检测是否投票</span></span><br><span class="line">        require(voters[voter].weight == <span class="number">0</span>);<span class="comment">//投票权重是否为零</span></span><br><span class="line">        voters[voter].weight = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//投票者将自己的投票机会授权另一个地址</span></span><br><span class="line">    <span class="function">function <span class="title">delegate</span><span class="params">(address to)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        Voter storage sender = voters[msg.sender];</span><br><span class="line">        require(!sender.voted, <span class="string">&quot;You already voted.&quot;</span>);</span><br><span class="line">        require(to != msg.sender, <span class="string">&quot;Self-delegation is disallowed.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (voters[to].delegate != address(<span class="number">0</span>)) &#123;</span><br><span class="line">            to = voters[to].delegate;</span><br><span class="line"></span><br><span class="line">            require(to != msg.sender, <span class="string">&quot;Found loop in delegation.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sender.voted = <span class="keyword">true</span>;</span><br><span class="line">        sender.delegate = to;</span><br><span class="line">        Voter storage delegate_ = voters[to];</span><br><span class="line">        <span class="keyword">if</span> (delegate_.voted) &#123;</span><br><span class="line">            </span><br><span class="line">            proposals[delegate_.vote].voteCount += sender.weight;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           </span><br><span class="line">            delegate_.weight += sender.weight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//投票者根据提案列表编号（proposal）进行投票</span></span><br><span class="line">    <span class="function">function <span class="title">vote</span><span class="params">(uint proposal)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        Voter storage sender = voters[msg.sender];<span class="comment">//修改合约中的存储状态</span></span><br><span class="line">        <span class="comment">//未加storagege修饰词，会导致sender是局部变量，调用结束会清除</span></span><br><span class="line">        require(sender.weight != <span class="number">0</span>, <span class="string">&quot;Has no right to vote&quot;</span>);</span><br><span class="line">        require(!sender.voted, <span class="string">&quot;Already voted.&quot;</span>);</span><br><span class="line">        sender.voted = <span class="keyword">true</span>;</span><br><span class="line">        sender.vote = proposal;</span><br><span class="line">        </span><br><span class="line">        proposals[proposal].voteCount += sender.weight;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据proposals里的票数统计（voteCount）计算出票数最多的提案编号</span></span><br><span class="line">    <span class="function">function <span class="title">winningProposal</span><span class="params">()</span> <span class="keyword">public</span> view</span></span><br><span class="line"><span class="function">            <span class="title">returns</span> <span class="params">(uint winningProposal_)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        uint winningVoteCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (uint p = <span class="number">0</span>; p &lt; proposals.length; p++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (proposals[p].voteCount &gt; winningVoteCount) &#123;</span><br><span class="line">                winningVoteCount = proposals[p].voteCount;</span><br><span class="line">                winningProposal_ = p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取票数最多的提案名称，其中调用winningProposal（）函数</span></span><br><span class="line">    <span class="function">function <span class="title">winnerName</span><span class="params">()</span> <span class="keyword">public</span> view</span></span><br><span class="line"><span class="function">            <span class="title">returns</span> <span class="params">(bytes32 winnerName_)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        winnerName_ = proposals[winningProposal()].name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-revert-、assert-、require-三者的区别"><a href="#1-revert-、assert-、require-三者的区别" class="headerlink" title="1.revert()、assert()、require()三者的区别"></a>1.revert()、assert()、require()三者的区别</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(msg.sender != owner) &#123; <span class="keyword">throw</span>; &#125; &lt;^<span class="number">0.4</span><span class="number">.13</span></span><br><span class="line">之后<span class="keyword">throw</span>关键字被弃用</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>assert</code> 和 <code>require</code> 可用于检查条件并在条件不满足时抛出异常。</li>
<li><code>assert</code> 函数只能用于测试内部错误，并检查非变量。 <code>require</code> 函数用于确认条件有效性，并提供一个字符串消息</li>
<li><code>revert</code> 函数可以用来标记错误并恢复当前的调用。调用包中有关错误的详细信息返回给调用者</li>
</ul>
<p><img src="/2021/03/22/14/image-20210320220120589.png" alt="image-20210320220120589"></p>
<p> Solidity 对一个 <code>require</code> 式的异常执行回退操作（指令 <code>0xfd</code> ）并执行一个无效操作（指令 <code>0xfe</code> ）来引发 <code>assert</code> 式异常。想要保留交易原子性，最安全的做法是回退所有更改并使整个交易（或至少是调用）不产生效果</p>
<h4 id="2-memory与storage区别"><a href="#2-memory与storage区别" class="headerlink" title="2.memory与storage区别"></a>2.memory与storage区别</h4><div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>storage</th>
<th>memory</th>
</tr>
</thead>
<tbody>
<tr>
<td>储存的变量</td>
<td>函数外部声明的变量，即状态变量</td>
<td>函数内部声明的变量，即局部变量</td>
</tr>
<tr>
<td>存储的位置</td>
<td>区块链上，永久存在</td>
<td>内存中，运行完之后销毁</td>
</tr>
<tr>
<td>运行的位置</td>
<td>区块链网络上</td>
<td>单个节点</td>
</tr>
<tr>
<td>传递属性</td>
<td>指针传递</td>
<td>值传递</td>
</tr>
</tbody>
</table>
</div>
<p>两者使用成本与calldata</p>
<ul>
<li><p>storage</p>
<ul>
<li><p>存储中的数据是永久存在的。存储是一个key/value库</p>
</li>
<li><p>存储中的数据写入区块链，因此会修改状态，这也是存储使用成本高的原因。</p>
</li>
<li><p>占用一个256位的槽需要消耗20000 gas</p>
</li>
<li><p>修改一个已经使用的存储槽的值，需要消耗5000 gas</p>
</li>
<li><p>当清零一个存储槽时，会返还一定数量的gas</p>
</li>
<li><p>存储按256位的槽位分配，即使没有完全使用一个槽位，也需要支付其开销</p>
</li>
</ul>
</li>
<li><p>memory</p>
<ul>
<li>内存是一个字节数组，槽大小位256位（32字节）</li>
</ul>
</li>
<li><p>数据仅在函数执行期间存在，执行完毕后就被销毁</p>
<ul>
<li>读或写一个内存槽都会消耗3gas</li>
<li>为了避免矿工的工作量过大，22个操作之后的单操作成本会上涨</li>
</ul>
</li>
<li><p>calldata/调用数据</p>
<ul>
<li>调用数据是不可修改、非持久化的区域，用来保存函数参数，其行为类似于内存</li>
<li>外部函数的参数必须使用calldata，但是也可用于其他变量</li>
<li>调用数据避免了数据拷贝，并确保数据不被修改</li>
<li>函数也可以返回使用calldata声明的数组和结果，但是不可能分配这些类型</li>
</ul>
<p>但是本合约中的多数函数需要使用storage来防止一些危险的因数，防止投票者的一些状态丢失</p>
</li>
</ul>
<h4 id="3-函数权限关键字与修饰关键字"><a href="#3-函数权限关键字与修饰关键字" class="headerlink" title="3.函数权限关键字与修饰关键字"></a>3.函数权限关键字与修饰关键字</h4><p>函数关键字</p>
<ul>
<li><strong>public</strong>：只有 public 类型的函数才可以供外部访问，当一个状态变量的权限为 public 类型时，它就会自动生成一个可供外部调用的 get 函数。当函数声明时，它默认为是 public 类型，而状态变量声明时，默认为 internal 类型。</li>
<li><strong>private</strong>：只能在当前类中进行访问，子类无法继承，也无法调用或访问。</li>
<li><strong>internal</strong>：子类继承父类，子类可以访问父类的 internal 函数，同时，使用 using for 关键字后，本类可以使用被调用类的 internal 函数。</li>
<li><strong>external</strong>：被声明的函数只能在合约外部调用。</li>
</ul>
<p>修饰关键字</p>
<ul>
<li><strong>modifier</strong>：被 modifier 关键字声明的关键字所修饰的函数只能在满足 modifier 关键字声明的关键字的要求后才会被执行。</li>
<li><strong>constant</strong>：被声明为 constant 的状态变量只能使用那些在编译时有确定值的表达式来给它们赋值。任何通过访问 内存、链数据（例如 now，this.balance 或 block.number）或执行数据（msg.gas）或对外部合约的调用来给它们赋值都是不允许的。不是所有类型的状态变量都支持用 constant 来修饰，当前支持的仅有值类型和字符串。</li>
<li><strong>view</strong>：被该关键字修饰的状态变量只能读取其值，不能对该状态变量的值进行修改。</li>
<li><strong>pure</strong>：被该关键字修饰的状态变量既不能读取变量，也不能修改该变量。</li>
</ul>
<h4 id="4-变长字节数组"><a href="#4-变长字节数组" class="headerlink" title="4.变长字节数组"></a>4.变长字节数组</h4><ul>
<li>一个元素类型为 <code>T</code>，固定长度为 <code>k</code> 的数组可以声明为 <code>T[k]</code>，而动态数组声明为 <code>T[]</code> </li>
<li>数组下标是从 0 开始的，且访问数组时的下标顺序与声明时相反 ，T[0]代表最后一个元素</li>
<li><code>.lenth</code>表示当前数组的长度。储存在storage的动态数组可以通过修改<code>.lenth</code>修改数组大小，memory的数组长度是固定的</li>
<li>变长的 存储（storage） 数组以及 <code>bytes</code> 类型（而不是 <code>string</code> 类型）都有一个叫做 <code>push</code> 的成员函数，它用来附加新的元素到数组末尾。 这个函数将返回新的数组长度</li>
</ul>
<h4 id="5-映射键值对"><a href="#5-映射键值对" class="headerlink" title="5.映射键值对"></a>5.映射键值对</h4><p><code>映射</code>或字典类型，一种键值对的映射关系存储结构。定义方式为<code>mapping(_KeyType =&gt; _KeyValue)</code>。键的类型允许除<code>映射</code>外的所有类型，如数组，合约，枚举，结构体。值的类型无限制。</p>
<p>简单来说，映射就是一个哈希表，每一个key与一个value互相对应，通过知道键值可以快速地定位到value</p>
<p>但是我们并不存储键的数据，仅仅存储它的<code>keccak256</code>哈希值，用来查找值时使用。</p>
<h4 id="6-tips"><a href="#6-tips" class="headerlink" title="6.tips"></a>6.tips</h4><p><code>solidity</code> 调用栈最深为<code>1024</code>,尽量用循环</p>
<h3 id="拍卖"><a href="#拍卖" class="headerlink" title="拍卖"></a>拍卖</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.22</span>;</span><br><span class="line"></span><br><span class="line">contract SimpleAuction &#123;</span><br><span class="line">    <span class="comment">// 最终受益者</span></span><br><span class="line">    address <span class="keyword">public</span> beneficiary;</span><br><span class="line">    <span class="comment">// 时间是unix的绝对时间戳（自1970-01-01以来的秒数）以秒为单位</span></span><br><span class="line">    uint <span class="keyword">public</span> auctionEnd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拍卖的当前状态</span></span><br><span class="line">    address <span class="keyword">public</span> highestBidder;<span class="comment">//最高出价者</span></span><br><span class="line">    uint <span class="keyword">public</span> highestBid;<span class="comment">//最高出价</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//可以取回的之前的出价</span></span><br><span class="line">    mapping(address =&gt; uint) pendingReturns;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拍卖结束后设为 true，将禁止所有的变更</span></span><br><span class="line">    bool ended;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 变更触发的事件</span></span><br><span class="line">    <span class="function">event <span class="title">HighestBidIncreased</span><span class="params">(address bidder, uint amount)</span></span>;</span><br><span class="line">    <span class="function">event <span class="title">AuctionEnded</span><span class="params">(address winner, uint amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以下是所谓的 natspec 注释，可以通过三个斜杠来识别。</span></span><br><span class="line">    <span class="comment">// 当用户被要求确认交易时将显示。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 以受益者地址 `_beneficiary` 的名义，</span></span><br><span class="line">    <span class="comment">/// 创建一个简单的拍卖，拍卖时间为 `_biddingTime` 秒。</span></span><br><span class="line">    constructor(</span><br><span class="line">        uint _biddingTime,</span><br><span class="line">        address _beneficiary</span><br><span class="line">    ) <span class="keyword">public</span> &#123;</span><br><span class="line">        beneficiary = _beneficiary;</span><br><span class="line">        auctionEnd = now + _biddingTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 对拍卖进行出价，具体的出价随交易一起发送。</span></span><br><span class="line">    <span class="comment">/// 如果没有在拍卖中胜出，则返还出价。</span></span><br><span class="line">    <span class="function">function <span class="title">bid</span><span class="params">()</span> <span class="keyword">public</span> payable </span>&#123;</span><br><span class="line">        <span class="comment">// 参数不是必要的。因为所有的信息已经包含在了交易中。</span></span><br><span class="line">        <span class="comment">// 对于能接收以太币的函数，关键字 payable 是必须的。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果拍卖已结束，撤销函数的调用。</span></span><br><span class="line">        require(</span><br><span class="line">            now &lt;= auctionEnd,</span><br><span class="line">            <span class="string">&quot;Auction already ended.&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果出价不够高，返还你的钱</span></span><br><span class="line">        require(</span><br><span class="line">            msg.value &gt; highestBid,</span><br><span class="line">            <span class="string">&quot;There already is a higher bid.&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (highestBid != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 返还出价时，简单地直接调用 highestBidder.send(highestBid) 函数，</span></span><br><span class="line">            <span class="comment">// 是有安全风险的，因为它有可能执行一个非信任合约。</span></span><br><span class="line">            <span class="comment">// 更为安全的做法是让接收方自己提取金钱。</span></span><br><span class="line">            pendingReturns[highestBidder] += highestBid;</span><br><span class="line">        &#125;</span><br><span class="line">        highestBidder = msg.sender;</span><br><span class="line">        highestBid = msg.value;</span><br><span class="line">        <span class="function">emit <span class="title">HighestBidIncreased</span><span class="params">(msg.sender, msg.value)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 取回出价（当该出价已被超越）</span></span><br><span class="line">    <span class="function">function <span class="title">withdraw</span><span class="params">()</span> <span class="keyword">public</span> <span class="title">returns</span> <span class="params">(bool)</span> </span>&#123;</span><br><span class="line">        uint amount = pendingReturns[msg.sender];</span><br><span class="line">        <span class="keyword">if</span> (amount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 这里很重要，首先要设零值。</span></span><br><span class="line">            <span class="comment">// 因为，作为接收调用的一部分，</span></span><br><span class="line">            <span class="comment">// 接收者可以在 `send` 返回之前，重新调用该函数。</span></span><br><span class="line">            pendingReturns[msg.sender] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!msg.sender.send(amount)) &#123;</span><br><span class="line">                <span class="comment">// 这里不需抛出异常，只需重置未付款</span></span><br><span class="line">                pendingReturns[msg.sender] = amount;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 结束拍卖，并把最高的出价发送给受益人</span></span><br><span class="line">    <span class="function">function <span class="title">auctionEnd</span><span class="params">()</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 对于可与其他合约交互的函数（意味着它会调用其他函数或发送以太币），</span></span><br><span class="line">        <span class="comment">// 一个好的指导方针是将其结构分为三个阶段：</span></span><br><span class="line">        <span class="comment">// 1. 检查条件</span></span><br><span class="line">        <span class="comment">// 2. 执行动作 (可能会改变条件)</span></span><br><span class="line">        <span class="comment">// 3. 与其他合约交互</span></span><br><span class="line">        <span class="comment">// 如果这些阶段相混合，其他的合约可能会回调当前合约并修改状态，</span></span><br><span class="line">        <span class="comment">// 或者导致某些效果（比如支付以太币）多次生效。</span></span><br><span class="line">        <span class="comment">// 如果合约内调用的函数包含了与外部合约的交互，</span></span><br><span class="line">        <span class="comment">// 则它也会被认为是与外部合约有交互的。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 条件</span></span><br><span class="line">        require(now &gt;= auctionEnd, <span class="string">&quot;Auction not yet ended.&quot;</span>);</span><br><span class="line">        require(!ended, <span class="string">&quot;auctionEnd has already been called.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 生效</span></span><br><span class="line">        ended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="function">emit <span class="title">AuctionEnded</span><span class="params">(highestBidder, highestBid)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 交互</span></span><br><span class="line">        beneficiary.transfer(highestBid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-事件"><a href="#1-事件" class="headerlink" title="1.事件"></a>1.事件</h4><p>事件是能方便地调用以太坊虚拟机日志功能的接口。</p>
<ul>
<li>定义事件<code>event EventName(address bidder, uint amount);</code></li>
<li>触发事件<code>emit EventName(msg.sender, msg.value);</code></li>
<li>本合约使用日志功能记录不同地址的不同出价，记录后我们可以搜索事件</li>
<li>其中有一个参数修饰是 indexed ，用来表示这个参数用作索引，查询日志时就可以根据这个索引进行过滤</li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/352528276">事件搜索</a></li>
</ul>
<h4 id="2-函数返回值"><a href="#2-函数返回值" class="headerlink" title="2.函数返回值"></a>2.函数返回值</h4><ul>
<li><p>使用返回变量名</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arithmetic</span>(<span class="params">uint _a, uint _b</span>) <span class="title">public</span> <span class="title">pure</span></span></span><br><span class="line"><span class="function">        <span class="title">returns</span> (<span class="params">uint o_sum, uint o_product</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        o_sum = _a + _b;</span><br><span class="line">        o_product = _a * _b;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接在return语句中提供返回值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arithmetic</span>(<span class="params">uint _a, uint _b</span>) <span class="title">public</span> <span class="title">pure</span></span></span><br><span class="line"><span class="function">        <span class="title">returns</span> (<span class="params">uint o_sum, uint o_product</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (_a + _b, _a * _b);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Getter 函数</p>
<p>所有定义为public的状态变量都有getter函数，由编译器自动创建。该函数与变量具有相同的名称，并且具有外部可见性</p>
</li>
</ul>
<h4 id="3-payable"><a href="#3-payable" class="headerlink" title="3.payable"></a>3.payable</h4><p>如果在函数中涉及到以太币的转移，需要使用到payable关键词。意味着可以在调用这笔函数的消息中附带以太币。</p>
<h4 id="4-重入攻击-Re-Entrancy"><a href="#4-重入攻击-Re-Entrancy" class="headerlink" title="4.重入攻击-Re-Entrancy"></a>4.重入攻击-Re-Entrancy</h4><p>以太坊上的智能合约彼此之间可以相互调用。假设在一个合约A执行过程中发生了一次外部的合约B调用，并且合约B是由黑客所控制的，合约B的调用过程中可以重新进入合约A的调用。如果合约A在执行外部合约调用之前并未完成自己的内部状态更新，则有可能会被合约B利用从而盗取资产。</p>
<p>先分析DAO攻击中的问题代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withDraw</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        uint amount = userBalannce[msg.sender];</span><br><span class="line">        <span class="keyword">if</span>(amount &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            msg.sender.call.value(amount)();</span><br><span class="line">            userBalannce[msg.sender] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>该函数的功能是实现提款操作。逻辑顺序是，先执行退款操作，再将账户的余额进行相应扣除。</p>
<p>首先由于Gas的限制，不需要担心死循环。但是以太币转账会触发代码执行，如果接收方是智能合约，那么就能在接受的过程中再次调用withdraw()函数。</p>
<ul>
<li><strong>回退函数(fallback function)</strong></li>
</ul>
<p>每一个合约有且仅有一个没有名字的函数。这个函数无参数，也无返回值。如果调用合约时，没有匹配上任何一个函数(或者没有传哪怕一点数据)，就会调用默认的回退函数。此外，当合约收到<code>ether</code>时（没有任何其它数据），这个函数也会被执行。</p>
<p>如果构造一个 fallback 函数，函数里面也调用对方的 withdraw 函数的话，那将会产生一个循环调用转账功能，存在漏洞的合约会不断向攻击者合约转账，终止循环结束（以太坊 gas 有上限）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">payable</span></span>&#123;<span class="comment">//定义payable修饰使得fallback函数具备转账功能</span></span><br><span class="line">        test++;<span class="comment">//记录尝试次数</span></span><br><span class="line">        Victim(msg.sender).withDraw();<span class="comment">//调用目标合约的转账函数</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1628485">详细复现</a></p>
<p>本合约中的withdraw函数编写符合退款逻辑，避免了重入攻击</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">      uint amount = pendingReturns[msg.sender];</span><br><span class="line">      <span class="keyword">if</span> (amount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          pendingReturns[msg.sender] = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> (!msg.sender.send(amount)) &#123;</span><br><span class="line">              pendingReturns[msg.sender] = amount;</span><br><span class="line">              <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>把写操作放在外部函数调用之前：先扣除在进行转账</p>
<h5 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h5><ul>
<li>变成“先记录，后转账”的模式-(Checks-effects-interactions)</li>
<li>采用<code>transfer()</code>函数进行转账，或采用<code>to.call.gas(2300).value(amount)();</code> 函数对<code>gas</code>进行限制。</li>
<li>采用锁机制</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> modifier onlyUnlocked&#123;</span><br><span class="line">        require(unlocked,<span class="string">&quot;contract is already locked&quot;</span>);</span><br><span class="line">        unlocked = <span class="keyword">false</span>;</span><br><span class="line">        _;</span><br><span class="line">        unlocked = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function">function <span class="title">withdraw</span><span class="params">()</span> onlyUnlocked</span>&#123;</span><br><span class="line">      uint256 amount = balances[msg.sender];</span><br><span class="line">      require(msg.sender.call.value(amount)());</span><br><span class="line">      balances[msg.sender] = <span class="number">0</span>;  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>modifer</p>
</li>
<li><p>```java<br>//定义修饰器</p>
<pre><code>modifier modifierfun(uint value)&#123;
    require(value &gt;= 10); 
    _;  //代表修饰器所修饰函数中的代码。
&#125;
// 修饰器修饰函数。 (先执行修饰器中的代码，再执行函数中的代码)
function setValue(uint num) modifierfun(num)&#123;
    a = num;
&#125;
</code></pre><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 盲拍</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">pragma solidity &gt;=<span class="number">0.5</span><span class="number">.0</span> &lt;<span class="number">0.7</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract BlindAuction &#123;</span><br><span class="line">    struct Bid &#123;</span><br><span class="line">        bytes32 blindedBid;</span><br><span class="line">        <span class="keyword">uint</span> deposit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    address payable <span class="keyword">public</span> beneficiary;</span><br><span class="line">    <span class="keyword">uint</span> <span class="keyword">public</span> biddingEnd;</span><br><span class="line">    <span class="keyword">uint</span> <span class="keyword">public</span> revealEnd;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">public</span> ended;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; Bid[]) <span class="keyword">public</span> bids;</span><br><span class="line"></span><br><span class="line">    address <span class="keyword">public</span> highestBidder;</span><br><span class="line">    <span class="keyword">uint</span> <span class="keyword">public</span> highestBid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以取回的之前的出价</span></span><br><span class="line">    mapping(address =&gt; <span class="keyword">uint</span>) pendingReturns;</span><br><span class="line"></span><br><span class="line">    event AuctionEnded(address winner, <span class="keyword">uint</span> highestBid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 使用 modifier 可以更便捷的校验函数的入参。</span></span><br><span class="line">    <span class="comment">/// onlyBefore 会被用于后面的 bid 函数：</span></span><br><span class="line">    <span class="comment">/// 新的函数体是由 modifier 本身的函数体，并用原函数体替换 `_;` 语句来组成的。</span></span><br><span class="line">    modifier onlyBefore(<span class="keyword">uint</span> _time) &#123; <span class="keyword">require</span>(now &lt; _time); _; &#125;</span><br><span class="line">    modifier onlyAfter(<span class="keyword">uint</span> _time) &#123; <span class="keyword">require</span>(now &gt; _time); _; &#125;</span><br><span class="line"></span><br><span class="line">    constructor(</span><br><span class="line">        <span class="keyword">uint</span> _biddingTime,</span><br><span class="line">        <span class="keyword">uint</span> _revealTime,</span><br><span class="line">        address payable _beneficiary</span><br><span class="line">    ) <span class="keyword">public</span> &#123;</span><br><span class="line">        beneficiary = _beneficiary;</span><br><span class="line">        biddingEnd = now + _biddingTime;</span><br><span class="line">        revealEnd = biddingEnd + _revealTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 可以通过 _blindedBid = keccak256(value, fake, secret)</span></span><br><span class="line">    <span class="comment">/// 设置一个秘密竞拍。</span></span><br><span class="line">    <span class="comment">/// 只有在出价披露阶段被正确披露，已发送的以太币才会被退还。</span></span><br><span class="line">    <span class="comment">/// 如果与出价一起发送的以太币至少为 “value” 且 “fake” 不为真，则出价有效。</span></span><br><span class="line">    <span class="comment">/// 将 “fake” 设置为 true ，然后发送满足订金金额但又不与出价相同的金额是隐藏实际出价的方法。</span></span><br><span class="line">    <span class="comment">/// 同一个地址可以放置多个出价。</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">bid</span><span class="params">(bytes32 _blindedBid)</span></span></span><br><span class="line"><span class="function">        <span class="title">public</span></span></span><br><span class="line"><span class="function">        <span class="title">payable</span></span></span><br><span class="line"><span class="function">        <span class="title">onlyBefore</span><span class="params">(biddingEnd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        bids[msg.sender].push(Bid(&#123;</span><br><span class="line">            blindedBid: _blindedBid,</span><br><span class="line">            deposit: msg.value</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 披露你的秘密竞拍出价。</span></span><br><span class="line">    <span class="comment">/// 对于所有正确披露的无效出价以及除最高出价以外的所有出价，你都将获得退款。</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">reveal</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint</span>[] _values,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">bool</span>[] _fake,</span></span></span><br><span class="line"><span class="function"><span class="params">        bytes32[] _secret</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br><span class="line"><span class="function">        <span class="title">public</span></span></span><br><span class="line"><span class="function">        <span class="title">onlyAfter</span><span class="params">(biddingEnd)</span></span></span><br><span class="line"><span class="function">        <span class="title">onlyBefore</span><span class="params">(revealEnd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">uint</span> length = bids[msg.sender].length;</span><br><span class="line">        <span class="keyword">require</span>(_values.length == length);</span><br><span class="line">        <span class="keyword">require</span>(_fake.length == length);</span><br><span class="line">        <span class="keyword">require</span>(_secret.length == length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint</span> refund;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">uint</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            Bid storage bid = bids[msg.sender][i];</span><br><span class="line">            (<span class="keyword">uint</span> value, <span class="keyword">bool</span> fake, bytes32 secret) =</span><br><span class="line">                    (_values[i], _fake[i], _secret[i]);</span><br><span class="line">            <span class="keyword">if</span> (bid.blindedBid != keccak256(value, fake, secret)) &#123;</span><br><span class="line">                <span class="comment">// 出价未能正确披露</span></span><br><span class="line">                <span class="comment">// 不返还订金</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            refund += bid.deposit;</span><br><span class="line">            <span class="keyword">if</span> (!fake &amp;&amp; bid.deposit &gt;= value) &#123;</span><br><span class="line">                <span class="keyword">if</span> (placeBid(msg.sender, value))</span><br><span class="line">                    refund -= value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 使发送者不可能再次认领同一笔订金</span></span><br><span class="line">            bid.blindedBid = bytes32(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        msg.sender.transfer(refund);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这是一个 &quot;internal&quot; 函数， 意味着它只能在本合约（或继承合约）内被调用</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">placeBid</span><span class="params">(address bidder, <span class="keyword">uint</span> value)</span> <span class="title">internal</span></span></span><br><span class="line"><span class="function">            <span class="title">returns</span> <span class="params">(<span class="keyword">bool</span> success)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value &lt;= highestBid) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (highestBidder != address(<span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="comment">// 返还之前的最高出价</span></span><br><span class="line">            pendingReturns[highestBidder] += highestBid;</span><br><span class="line">        &#125;</span><br><span class="line">        highestBid = value;</span><br><span class="line">        highestBidder = bidder;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 取回出价（当该出价已被超越）</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span><span class="params">()</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="keyword">uint</span> amount = pendingReturns[msg.sender];</span><br><span class="line">        <span class="keyword">if</span> (amount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 这里很重要，首先要设零值。</span></span><br><span class="line">            <span class="comment">// 因为，作为接收调用的一部分，</span></span><br><span class="line">            <span class="comment">// 接收者可以在 `transfer` 返回之前重新调用该函数。（可查看上面关于‘条件 -&gt; 影响 -&gt; 交互’的标注）</span></span><br><span class="line">            pendingReturns[msg.sender] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            msg.sender.transfer(amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 结束拍卖，并把最高的出价发送给受益人</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">auctionEnd</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="title">public</span></span></span><br><span class="line"><span class="function">        <span class="title">onlyAfter</span><span class="params">(revealEnd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">require</span>(!ended);</span><br><span class="line">        emit AuctionEnded(highestBidder, highestBid);</span><br><span class="line">        ended = <span class="keyword">true</span>;</span><br><span class="line">        beneficiary.transfer(highestBid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9bfe756410d9">代码分析</a></p>
<p>由于区块链上面的交易都是公开透明的，前面的拍卖合约可以通过查询每一笔交易轻易得知目前的最高价。要实现盲拍确实困难。上述合约通过引入伪出价，使得真实的出价被隐藏在众多交易中，并且通过keccak256校验防止竞拍者修改自己的出价记录。实现一定程度上的盲拍。</p>
<h4 id="1-转账函数"><a href="#1-转账函数" class="headerlink" title="1.转账函数"></a>1.转账函数</h4><h5 id="transfer"><a href="#transfer" class="headerlink" title="\.transfer()"></a>\<address>.transfer()</address></h5><p><code>address.transfer()</code>方法相当于 <code>require(address.send())</code>, 使用<code>transfer</code>方法也需要注意两点，第一点，跟<code>send</code>方法一样，<code>transfer</code>也只提供了2300 Energy。 第二点，不同于<code>send</code>方法，<code>transfer</code>方法提供了一种更安全的机制，失败的时候会抛出异常，所有已经完成的操作都会回滚。</p>
<h5 id="send"><a href="#send" class="headerlink" title="\.send()"></a>\<address>.send()</address></h5><p>使用<code>address.send()</code>方法需要注意两点，第一点，如上所述，它只提供了2300 Energy。 第二点，对于执行失败的<code>send</code>方法，<code>send</code>函数仅仅返回<code>false</code>，不会抛出任何异常。因此调用<code>send</code>方法的时候需要配合<code>require</code>使用，否则可能会出现交易上链，用户支付了fee，但是所有的状态改动没有生效。</p>
<h5 id="call-value"><a href="#call-value" class="headerlink" title="\.call.value()"></a>\<address>.call.value()</address></h5><p>相对于前两种方法，<code>address.call.value(amount)( )</code>使用起来更加灵活，适用的范围也更加广泛。因为这种方式提供了指定energy数量的接口，使用的时候不再受2300 Energy的限制，可以允许接收函数执行更复杂的操作。使用这种方法也需要注意两点问题。第一个，同<code>send()</code>一样，执行失败的时候此函数不会抛出异常，只返回<code>false</code>，需要用户手动处理返回结果，使用的时候建议配合<code>require</code>一起使用。第二点，如果不显示指定Energy数量，默认的Energy数量是用户所有可用的Energy。Energy数量可以通过修饰器 <code>.gas(energyLimit)</code>来设定。</p>
<h4 id="2-构造函数"><a href="#2-构造函数" class="headerlink" title="2.构造函数"></a>2.构造函数</h4><p>solidity 的内置变量 <code>now</code> 将返回当前的unix时间戳（自1970年1月1日以来经过的秒数）。在这里，以秒为单位，因此 <code>_biddingTime</code>, <code>_revealTime</code> 都是从当前开始经过XXX秒后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">constructor(</span><br><span class="line">    uint _biddingTime,</span><br><span class="line">    uint _revealTime,</span><br><span class="line">    address payable _beneficiary</span><br><span class="line">) <span class="keyword">public</span> &#123;</span><br><span class="line">    beneficiary = _beneficiary;</span><br><span class="line">    biddingEnd = now + _biddingTime;</span><br><span class="line">    revealEnd = biddingEnd + _revealTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-constructor"><a href="#3-constructor" class="headerlink" title="3. constructor"></a>3. constructor</h4><p>构造函数是使用 <code>constructor</code> 关键字声明的一个可选函数, 它在创建合约时执行, 可以在其中运行合约初始化代码。如果没有构造函数, 合约将假定采用默认构造函数, 它等效于 <code>constructor() &#123;&#125;</code> 。</p>
<p>在执行构造函数代码之前, 如果状态变量可以初始化为指定值; 如果不初始化, 则为零。</p>
<p>在 0.7.0 版本之前, 你需要通过 <code>internal</code> 或 <code>public</code> 指定构造函数的可见性。</p>
<h3 id="状态机"><a href="#状态机" class="headerlink" title="状态机"></a>状态机</h3><p>此处代码未采用书上的例子，转自一篇<a target="_blank" rel="noopener" href="https://my.oschina.net/u/4327212/blog/4504765">文章</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">uint <span class="keyword">public</span> value;<span class="comment">//定义商品的价值</span></span><br><span class="line">    address payable <span class="keyword">public</span> seller;<span class="comment">//定义一个payable类型的卖方</span></span><br><span class="line">    address payable <span class="keyword">public</span> buyer;<span class="comment">//定义一个payable类型的买方</span></span><br><span class="line">    </span><br><span class="line">    enum State &#123; Created, Locked, Release, Inactive &#125;</span><br><span class="line">    <span class="comment">//定义一个枚举类型包含四个状态变量</span></span><br><span class="line">    State <span class="keyword">public</span> state;<span class="comment">//定义枚举变量</span></span><br><span class="line">    </span><br><span class="line">    modifier condition(<span class="keyword">bool</span> _condition)&#123;</span><br><span class="line">        <span class="keyword">require</span>(_condition);</span><br><span class="line">        _;</span><br><span class="line">    &#125;<span class="comment">//判断是否bool型变量condition是否为true</span></span><br><span class="line">    </span><br><span class="line">    modifier onlyBuyer()&#123;</span><br><span class="line">        <span class="keyword">require</span>(</span><br><span class="line">            msg.sender == buyer,</span><br><span class="line">            <span class="string">&quot;Only buyer can call this.&quot;</span></span><br><span class="line">        );</span><br><span class="line">        _;</span><br><span class="line">    &#125;<span class="comment">//判断调用地址是否为买方地址</span></span><br><span class="line">    </span><br><span class="line">    modifier onlySeller()&#123;</span><br><span class="line">        <span class="keyword">require</span>(</span><br><span class="line">            msg.sender == seller,</span><br><span class="line">            <span class="string">&quot;Only seller can call this.&quot;</span></span><br><span class="line">            );</span><br><span class="line">            _;</span><br><span class="line">    &#125;<span class="comment">//判断调用地址是否为卖方地址</span></span><br><span class="line">    </span><br><span class="line">    modifier inState(State _state) &#123;</span><br><span class="line">        <span class="keyword">require</span>(</span><br><span class="line">            state == _state,</span><br><span class="line">            <span class="string">&quot;Invalid state.&quot;</span></span><br><span class="line">            );</span><br><span class="line">            _;</span><br><span class="line">    &#125;<span class="comment">//判断是否在对应的交易阶段调用对应的函数</span></span><br><span class="line"> <span class="comment">//以下是四个阶段通知的声明，方便后续可以通过log日志获取详细信息</span></span><br><span class="line">    event Aborted();</span><br><span class="line">    event PurchaseConfirmed();</span><br><span class="line">    event ItemReceived();</span><br><span class="line">    event SellerRefunded();</span><br><span class="line">    <span class="comment">//撤回函数</span></span><br><span class="line">     <span class="function"><span class="keyword">function</span> <span class="title">abort</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    <span class="title">public</span></span></span><br><span class="line"><span class="function">    <span class="title">onlySeller</span>//调用地址为卖方地址才可运行该函数</span></span><br><span class="line"><span class="function">    <span class="title">inState</span>(<span class="params">State.Created</span>)//当状态处于合约产生状态时可调用</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        emit Aborted();<span class="comment">//调用log日志显示</span></span><br><span class="line">        state = State.Inactive;<span class="comment">//状态转为不工作状态</span></span><br><span class="line">        seller.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//买家确认购买函数</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">confirmPurchase</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    <span class="title">public</span></span></span><br><span class="line"><span class="function">    <span class="title">inState</span>(<span class="params">State.Created</span>)//处于合约产生阶段可调用</span></span><br><span class="line"><span class="function">    <span class="title">condition</span>(<span class="params">msg.value == (<span class="params"> <span class="number">2</span> * value</span>)</span>)//购买人的输入<span class="title">value</span>必须持有2*<span class="title">value</span></span></span><br><span class="line"><span class="function">    <span class="title">payable</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        emit PurchaseConfirmed();</span><br><span class="line">        buyer = msg.sender;<span class="comment">//对买方地址进行赋值</span></span><br><span class="line">        state = State.Locked;<span class="comment">//状态切换为锁定订单</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//买家确认收获函数</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">confirmReceived</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    <span class="title">public</span></span></span><br><span class="line"><span class="function">    <span class="title">onlyBuyer</span>//限制买家进行调用</span></span><br><span class="line"><span class="function">    <span class="title">inState</span>(<span class="params">State.Locked</span>)//处于合约锁定阶段可以调用</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        emit ItemReceived();</span><br><span class="line">        state = State.Release;<span class="comment">//转换为合约发布阶段</span></span><br><span class="line">        buyer.transfer(value);<span class="comment">//买方退回value</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//卖方收回资金函数</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">refundSeller</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    <span class="title">public</span></span></span><br><span class="line"><span class="function">    <span class="title">onlySeller</span>//只有卖方能够调用</span></span><br><span class="line"><span class="function">    <span class="title">inState</span>(<span class="params">State.Release</span>)//状态是合约锁定解除可调用</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        emit SellerRefunded();</span><br><span class="line">        state = State.Inactive;<span class="comment">//状态切换为合约不工作</span></span><br><span class="line">        seller.transfer(<span class="number">3</span> * value);<span class="comment">//返回3*value给卖家</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="debug调试"><a href="#debug调试" class="headerlink" title="debug调试"></a>debug调试</h4><p>对state的初始值有所疑问，所以进行了调试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">State</span> </span>&#123; Created, Locked, Release, Inactive &#125;</span><br><span class="line">    State <span class="keyword">public</span> state;</span><br></pre></td></tr></table></figure>
<p>采取remix在线部署后调试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line">contract tAest &#123;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">State</span> </span>&#123; Created, Locked, Release, Inactive &#125;</span><br><span class="line">    State <span class="keyword">public</span> state;</span><br><span class="line">    <span class="function">function <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         state=State.Locked;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/03/22/14/image-20210321220444930.png" alt="image-20210321220444930"></p>
<p>点击Debug进入调试，</p>
<p><img src="/2021/03/22/14/image-20210321220545250.png" alt="image-20210321220545250"></p>
<p>简单说明</p>
<p><img src="/2021/03/22/14/image-20210321220715904.png" alt="image-20210321220715904"></p>
<p>执行到最后也不会执行a函数，这是因为我们没有调用</p>
<p>回到部署的界面，点击一下a，会出现新的debug按钮，再点进去</p>
<p><img src="/2021/03/22/14/image-20210321220931862.png" alt="image-20210321220931862"></p>
<p>继续单步执行到一个pop指令后，<code>state</code> 的值会改变为Locked</p>
<p><img src="/2021/03/22/14/image-20210321221038692.png" alt="image-20210321221038692"></p>
<p>如果在外面直接改变state会报错。这是因为solidity语法在变量声明时只能进行一次赋值或者初始化为默认值</p>
<p><img src="/2021/03/22/14/image-20210321221346793-1616336155318.png" alt="image-20210321221346793"></p>
<h4 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a>权限控制</h4><p>本块内容其实在上面的合约中有所体现，采取白名单策略，同时编写设置白名单的函数，可以实现对用户的权限控制。</p>
<h2 id="第七章"><a href="#第七章" class="headerlink" title="第七章"></a>第七章</h2><h3 id="ERC20"><a href="#ERC20" class="headerlink" title="ERC20"></a>ERC20</h3><p>它诞生于2015年，到2017年9月被正式标准化。协议规定了具有可互换性（fungible）代币的一组基本接口，包括代币符号、发行量、转账、授权等</p>
<p><img src="/2021/03/22/14/image-20210322185706847.png" alt="image-20210322185706847"></p>
<h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">contract ERC20 &#123;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params"></span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">string name</span>)</span></span><br><span class="line"><span class="function">      <span class="function"><span class="keyword">function</span> <span class="title">symbol</span>(<span class="params"></span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">string symbol</span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="function"><span class="keyword">function</span> <span class="title">decimals</span>(<span class="params"></span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">uint8 decimals</span>)</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">      <span class="function"><span class="keyword">function</span> <span class="title">totalSupply</span>(<span class="params"></span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">uint totalSupply</span>)</span>;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">      <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">uint balance</span>)</span>;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">      <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint _value</span>) <span class="title">returns</span> (<span class="params">bool success</span>)</span>;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">      <span class="function"><span class="keyword">function</span> <span class="title">transferFrom</span>(<span class="params">address _from, address _to, uint _value</span>) <span class="title">returns</span> (<span class="params">bool success</span>)</span>;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">      <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address _spender, uint _value</span>) <span class="title">returns</span> (<span class="params">bool success</span>)</span>;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">      <span class="function"><span class="keyword">function</span> <span class="title">allowance</span>(<span class="params">address _owner, address _spender</span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">uint remaining</span>)</span>;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">      <span class="title">event</span> <span class="title">Transfer</span>(<span class="params">address indexed _from, address indexed _to, uint _value</span>)</span>;</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">event</span> <span class="title">Approval</span>(<span class="params">address indexed _owner, address indexed _spender, uint _value</span>)</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>name：代币名字</li>
<li>symbol：代币简称</li>
<li>decimals：token使用小数点，</li>
<li>totalSupply：token供应总量</li>
<li>balanceOf：某个地址（账户）的余额</li>
<li>transfer：从代币合约的调用者地址上转移_value的数量token到的地址_to，并且必须触发Transfer事件</li>
<li>transferFrom：从地址_from发送数量为_value的token到地址_to,必须触发Transfer事件。transferFrom方法用于允许合同代理某人转移token。条件是from账户必须经过了approve。</li>
<li>approve：允许_spender多次取回您的帐户，最高达_value金额。 如果再次调用此函数，它将以_value覆盖当前的余量。</li>
<li>allowance：返回_spender仍然被允许从_owner提取的金额。</li>
<li>Transfer：当成功转移token时，一定要触发Transfer事件</li>
<li>Approval：当调用approval函数成功时，一定要触发Approval事件</li>
</ul>
<p>理解后三个函数：如果账户A有1000个ETH，想允许B账户随意调用他的100个ETH</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. A账户按照以下形式调用approve函数approve(B,100)  </span><br><span class="line">2. B账户想用这100个ETH中的10个ETH给C账户，调用transferFrom(A, C, 10)  </span><br><span class="line">3. 调用allowance(A, B)可以查看B账户还能够调用A账户多少个token  </span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://gitee.com/ethergo/ether-erc20-token">部署自己的ERC20代币</a></p>
<h3 id="ERC721"><a href="#ERC721" class="headerlink" title="ERC721"></a>ERC721</h3><p>ERC 721 合约标准规定了一种不可替代的代币 Non-fungible Token, NFT ）的合约接 此类代币的最小单位为个，即在 ERC 20 标准中对应小数点位的 decimal 值为零</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">contract ERC721 &#123; </span><br><span class="line"><span class="comment">// Required method </span></span><br><span class="line">    <span class="function">function <span class="title">totalSupply</span><span class="params">()</span> constant <span class="title">returns</span> <span class="params">(uint256 totalSupply)</span></span>; </span><br><span class="line">    <span class="function">function <span class="title">balanceOf</span><span class="params">(address owner)</span> constant <span class="title">returns</span> <span class="params">(uint256 balance)</span></span>; </span><br><span class="line">    <span class="function">function <span class="title">owner0f</span><span class="params">(uint256 tokenid)</span> constant <span class="title">returns</span> <span class="params">(address owner)</span></span>; </span><br><span class="line">    <span class="function">function <span class="title">approve</span><span class="params">(address _to, uint256 _tokenid)</span></span>; </span><br><span class="line">    <span class="function">function <span class="title">takeOwnership</span><span class="params">(uint256 tokenid)</span></span>; </span><br><span class="line">    <span class="function">function <span class="title">transfer</span><span class="params">(address to, uint256 tokenid)</span></span>; </span><br><span class="line"><span class="comment">// Optional method </span></span><br><span class="line">    <span class="function">function <span class="title">name</span><span class="params">()</span> constant <span class="title">returns</span> <span class="params">(string name)</span></span>;</span><br><span class="line">    <span class="function">function <span class="title">symbol</span><span class="params">()</span> constant <span class="title">returns</span> <span class="params">(string symbol)</span></span>; </span><br><span class="line">    <span class="function">function <span class="title">tokenOfOwnerByindex</span><span class="params">(address owner, uint256 index)</span> constant returns </span></span><br><span class="line"><span class="function"><span class="params">(uint tokenid)</span></span>; </span><br><span class="line">    <span class="function">function <span class="title">tokenMetadata</span><span class="params">(uint256 tokenid)</span> constant <span class="title">returns</span> <span class="params">(string infoUrl)</span></span>; </span><br><span class="line"><span class="comment">//Events </span></span><br><span class="line">    <span class="function">event <span class="title">Transfer</span><span class="params">(address indexed _from, address indexed _to, uint256 _tokenid)</span></span>; </span><br><span class="line">    <span class="function">event <span class="title">Approval</span><span class="params">(address indexed owner, address indexed _approved, uint256 tokenid)</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出ERC721继承了ERC20标准的一些基本功能接口。同时加入一些新的功能函数</p>
<ul>
<li>owner0f：根据代币ID查询该代币持有者</li>
<li>tokenOfOwnerByindex：根据持有者及其索引查询所持有的代币ID</li>
<li>takeOwnership：与ERC20中的transferFrom一样</li>
<li>tokenMetadata：用于查看代币的元数据</li>
</ul>
<p>ERC721代表作CryptoKitties以太坊养猫</p>
<h2 id="第八章"><a href="#第八章" class="headerlink" title="第八章"></a>第八章</h2><p>本章主要是工具介绍和以太坊浏览器的使用</p>
<h2 id="第九章"><a href="#第九章" class="headerlink" title="第九章"></a>第九章</h2><p>以太坊性能优化</p>
<h2 id="第十章"><a href="#第十章" class="headerlink" title="第十章"></a>第十章</h2><p>以太坊隐私保护</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Zpano
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://zpano.cn/2021/03/22/14/" title="读《以太坊技术详解与实战》笔记（下）">https://zpano.cn/2021/03/22/14/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%89%E5%85%A8/" rel="tag"># 区块链安全</a>
              <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag"># 读书笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/03/21/13/" rel="prev" title="读《以太坊技术详解与实战》笔记（上）">
                  <i class="fa fa-chevron-left"></i> 读《以太坊技术详解与实战》笔记（上）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/06/07/15/" rel="next" title="区块链整数溢出漏洞">
                  区块链整数溢出漏洞 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zpano</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">199k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:01</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>















  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
